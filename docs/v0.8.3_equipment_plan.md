# v0.8.3 Equipment Properties & Subcategories - Implementation Plan

**Target:** Clean up weapon properties and add missing subcategories
**Effort:** 2-3 weeks
**Schema:** 1.3.0 → 1.3.1 (patch, additive changes only)
**Priority:** HIGH - Quick win, high value for consumers

---

## Problem Statement

### Current Issues

1. **Properties have embedded data** (violates DRY principle)
   ```json
   {
     "properties": ["versatile (1d10)", "thrown (range 20/60)"],
     "versatile_damage": {"dice": "1d10"},  // Data duplicated!
     "range": {"normal": 20, "long": 60}    // Data duplicated!
   }
   ```

2. **Missing weapon subcategories** (simple vs martial)
   - No way to filter weapons by complexity level
   - Can't query "give me all simple melee weapons"
   - Current: Only `weapon_type: "melee"/"ranged"`
   - Missing: simple/martial distinction

3. **Properties need normalization**
   - Current: `"versatile (1d10)"`, `"versatile (1d8)"`
   - Target: `"versatile"` (data in separate field)

---

## Current Property Inventory (from dist/srd_5_1/equipment.json)

### Properties with Embedded Data (NEEDS CLEANUP)
- `ammunition (range 25/100)` → `ammunition` (data in `range` field)
- `ammunition (range 80/320)` → `ammunition` (data in `range` field)
- `thrown (range 20/60)` → `thrown` (data in `range` field)
- `thrown (range 5/15)` → `thrown` (data in `range` field)
- `versatile (1d10)` → `versatile` (data in `versatile_damage` field)
- `versatile (1d8)` → `versatile` (data in `versatile_damage` field)

### Properties Already Clean (NO CHANGE)
- `finesse` ✅
- `heavy` ✅
- `light` ✅
- `loading` ✅
- `reach` ✅
- `special` ✅
- `two-­‐handed` ✅

---

## Implementation Plan

### Phase 1: Property Normalization (Week 1)

**Goal:** Remove embedded data from properties array

**Changes:**
1. Update `parse_equipment.py`:
   ```python
   def _normalize_properties(properties: list[str]) -> list[str]:
       """Strip embedded data from weapon properties."""
       normalized = []
       for prop in properties:
           # Remove parenthetical data
           clean_prop = re.sub(r'\s*\([^)]+\)', '', prop).strip()
           normalized.append(clean_prop)
       return normalized
   ```

2. Apply during equipment parsing (after extracting damage/range data)

3. Update tests:
   - Verify properties cleaned: `["versatile (1d10)"]` → `["versatile"]`
   - Verify data preserved: `versatile_damage` still has `"1d10"`
   - Verify range preserved: `range` still has `{normal: 20, long: 60}`

**Affected Items:** ~15-20 weapons with versatile/thrown/ammunition properties

**Schema Change:** None (properties is already `array<string>`)

---

### Phase 2: Weapon Proficiency Field (Week 1-2)

**Goal:** Add proficiency level (simple/martial) as independent field

**Current State:**
```json
{
  "name": "Longsword",
  "category": "weapon",
  "weapon_type": "melee",        // Already exists
  "proficiency": null             // Missing!
}
```

**Target State:**
```json
{
  "name": "Longsword",
  "category": "weapon",
  "weapon_type": "melee",        // Already exists: melee/ranged
  "proficiency": "martial",      // NEW: simple/martial
  "damage": {"dice": "1d8", "type": "slashing"},
  "versatile_damage": {"dice": "1d10"},  // Two-handed damage
  "properties": ["versatile"]    // CLEAN: no embedded data
}
```

**Proficiency Values:**
- `simple` - Club, Dagger, Mace, Quarterstaff, Light Crossbow, Shortbow, etc.
- `martial` - Battleaxe, Longsword, Warhammer, Longbow, Heavy Crossbow, etc.

**Why separate fields?**
- `weapon_type` (melee/ranged) and `proficiency` (simple/martial) are independent attributes
- Enables flexible queries: simple weapons, martial melee, ranged weapons, etc.
- Avoids concatenation like "martial_melee" which combines two separate concepts

**Implementation:**

1. **Option A: Extract from PDF table section headers** (PREFERRED)
   - SRD weapon tables have "Simple Melee Weapons", "Martial Melee Weapons" sections
   - Already captured in `section` field during extraction
   - Parse section → subcategory mapping

2. **Option B: Hardcoded lookup table** (FALLBACK)
   - If section not reliable, use weapon name → subcategory mapping
   - Based on SRD 5.1 weapon tables (pages 66-68)

**Code Changes:**
```python
# In parse_equipment.py
def _determine_weapon_proficiency(item: dict) -> str | None:
    """Determine weapon proficiency level from section or name."""
    if item.get('category') != 'weapon':
        return None

    section = item.get('section', '').lower()

    # Try section-based detection first
    if 'simple' in section:
        return 'simple'
    elif 'martial' in section:
        return 'martial'

    # Fallback: name-based lookup (if needed)
    # return WEAPON_PROFICIENCY_MAP.get(item['simple_name'])

    return None
```

**Tests:**
- Verify simple weapons: Club, Dagger, Mace, Shortbow → `"simple"`
- Verify martial weapons: Longsword, Greatsword, Longbow → `"martial"`
- Verify independence: Can query by proficiency OR weapon_type separately
- Verify combination: Can filter martial melee (proficiency="martial" AND weapon_type="melee")

**Schema Change:** New field `proficiency` (string | null), values: "simple" | "martial"

---

### Phase 3: Armor Subcategories (Week 2)

**Goal:** Normalize armor subcategories to match weapon pattern

**Current State:**
```json
{
  "name": "Chain Mail",
  "category": "armor",
  "sub_category": "heavy"  // Raw from PDF
}
```

**Options:**

**Option A: Keep as-is** (PREFERRED)
- Current values: `"light"`, `"medium"`, `"heavy"`
- Already clean, lowercase, normalized
- No change needed

**Option B: Be more explicit**
- Change to: `"light_armor"`, `"medium_armor"`, `"heavy_armor"`
- Consistency with weapon subcategories
- More verbose but clearer

**Recommendation:** Keep armor subcategories as-is (`"light"`, `"medium"`, `"heavy"`). They're already clean and don't need the suffix.

---

### Phase 4: Index Updates (Week 2)

**Goal:** Enable filtering by weapon subcategory

**Add to `indexer.py`:**
```python
def build_equipment_index(items: list[dict]) -> dict:
    by_name = {}
    by_category = defaultdict(list)
    by_proficiency = defaultdict(list)  # NEW!
    by_weapon_type = defaultdict(list)  # NEW!

    for item in items:
        item_id = item['id']
        by_name[item['simple_name']] = item_id
        by_category[item['category']].append(item_id)

        # NEW: Index by proficiency (weapons only)
        if proficiency := item.get('proficiency'):
            by_proficiency[proficiency].append(item_id)

        # NEW: Index by weapon_type (weapons only)
        if weapon_type := item.get('weapon_type'):
            by_weapon_type[weapon_type].append(item_id)

    return {
        'by_name': dict(sorted(by_name.items())),
        'by_category': {k: sorted(v) for k, v in sorted(by_category.items())},
        'by_proficiency': {k: sorted(v) for k, v in sorted(by_proficiency.items())},  # NEW!
        'by_weapon_type': {k: sorted(v) for k, v in sorted(by_weapon_type.items())},  # NEW!
    }
```

**Index Output:**
```json
{
  "equipment": {
    "by_proficiency": {
      "simple": ["item:club", "item:dagger", "item:light_crossbow", ...],
      "martial": ["item:longsword", "item:greatsword", "item:longbow", ...]
    },
    "by_weapon_type": {
      "melee": ["item:club", "item:longsword", "item:greatsword", ...],
      "ranged": ["item:shortbow", "item:longbow", "item:light_crossbow", ...]
    }
  }
}
```

**Benefits for Blackmoor:**
- Query: "Show me all simple weapons" → `index['equipment']['by_proficiency']['simple']`
- Query: "Show me all martial weapons" → `index['equipment']['by_proficiency']['martial']`
- Query: "Show me all ranged weapons" → `index['equipment']['by_weapon_type']['ranged']`
- **Combine client-side:** Simple melee = intersect `by_proficiency['simple']` with `by_weapon_type['melee']`
- Character creation: Filter weapons by proficiency, then by type as needed

---

### Phase 5: Documentation (Week 3)

**Update `docs/DATA_DICTIONARY.md`:**

**Equipment.properties (array<string>):**
- Clean property names without embedded data
- Canonical list:
  - `ammunition` - Requires ammunition to fire (range in `range` field)
  - `finesse` - Can use Dex instead of Str for attack/damage
  - `heavy` - Small creatures have disadvantage
  - `light` - Suitable for two-weapon fighting
  - `loading` - Can only fire once per action
  - `reach` - Adds 5 feet to reach
  - `special` - See weapon description for special rules
  - `thrown` - Can be thrown (range in `range` field)
  - `two-handed` - Requires two hands to use
  - `versatile` - Can be used one or two-handed (two-handed damage in `versatile_damage` field)

**Equipment.proficiency (string | null):**
- Weapons only: `"simple"` or `"martial"`
- Indicates proficiency level required to use weapon without penalty
- Armor/Gear: `null`

**Equipment.weapon_type (string | null):**
- Weapons only: `"melee"` or `"ranged"`
- Indicates primary attack range
- Armor/Gear: `null`

**Equipment.versatile_damage (object | null):**
- Weapons with `versatile` property: Damage when wielded with two hands
- Format: `{"dice": "1d10", "type": "slashing"}`
- Null for non-versatile weapons

**Update `docs/SCHEMAS.md`:**
- Document property normalization approach
- Document subcategory values
- Note that embedded data removed in v0.8.3

**Update `README.md`:**
- Note v0.8.3 changes in changelog
- Update examples to use clean properties

---

## Testing Strategy

### Unit Tests
- `test_parse_equipment.py`:
  - Test property normalization (embedded data removed)
  - Test proficiency assignment (all weapons have simple or martial)
  - Test weapon_type already populated (melee/ranged)
  - Test armor subcategories (unchanged)

### Integration Tests
- `test_golden_equipment.py`:
  - Update golden fixtures with clean properties
  - Verify longsword: `properties: ["versatile"]` not `["versatile (1d10)"]`
  - Verify longsword: `proficiency: "martial"` and `versatile_damage: {"dice": "1d10"}`
  - Verify dagger: `properties: ["finesse", "light", "thrown"]` not `["finesse", "light", "thrown (range 20/60)"]`
  - Verify dagger: `proficiency: "simple"` and `range: {"normal": 20, "long": 60}`

### Validation Tests
- All weapons have `proficiency` ("simple" or "martial")
- All weapons have `weapon_type` ("melee" or "ranged") - already exists
- All armor have `sub_category` (light, medium, or heavy) - unchanged
- All properties are clean (no parentheses or embedded data)
- Versatile weapons have both `properties: ["versatile"]` AND `versatile_damage` field
- Thrown weapons have both `properties: ["thrown"]` AND `range` field
- Ammunition weapons have both `properties: ["ammunition"]` AND `range` field

---

## Schema Version

**1.3.0**
- New field added: `proficiency` (string | null)
- Property normalization is data cleanup (not breaking)
- Additive changes: existing code continues to work

**Schema Changes:**
- **Added:** `proficiency` field to equipment schema (string | null, values: "simple" | "martial")
- **Clarified:** `versatile_damage` documentation (two-handed damage value)
- **Cleaned:** Properties array (embedded data removed, values normalized)

---

## Risks & Mitigations

### Risk: Section-based subcategory detection fails
**Mitigation:** Fallback to name-based lookup table for 100% coverage

### Risk: Property normalization loses data
**Mitigation:** Data already in separate fields (versatile_damage, range). Verify tests before/after.

### Risk: Breaking change for consumers expecting embedded data
**Mitigation:** Documented in CHANGELOG. Consumers should use structured fields (versatile_damage, range) not properties array.

---

## Success Criteria

✅ All weapon properties cleaned (no parentheses or embedded data)
✅ All weapons have `proficiency` field ("simple" or "martial")
✅ All weapons have `weapon_type` field (already exists: "melee" or "ranged")
✅ Index includes `by_proficiency` and `by_weapon_type` lookups
✅ 113+ tests passing
✅ Data quality unchanged (damage, range, versatile_damage preserved in structured fields)
✅ Documentation updated (DATA_DICTIONARY.md, SCHEMAS.md)
✅ Versatile weapons have clean property + separate versatile_damage field

---

## Timeline

**Week 1:**
- Day 1-2: Property normalization implementation + tests
- Day 3-4: Weapon subcategory implementation + tests
- Day 5: Integration testing, fixture updates

**Week 2:**
- Day 1-2: Index updates (by_subcategory)
- Day 3-4: Validation tests, edge case handling
- Day 5: Documentation updates

**Week 3:**
- Day 1-2: Final polish, CHANGELOG update
- Day 3-4: Build, validate, tag v0.8.3
- Day 5: Release notes, update integration guide for Blackmoor

**Total: 3 weeks (conservative estimate)**

---

## Next Steps

1. ✅ Get user approval on v0.8.3 scope
2. Implement property normalization
3. Implement weapon subcategories
4. Update indexes
5. Update documentation
6. Release v0.8.3

**Related Documents:**
- `docs/TODO.md` - Equipment section
- `docs/external/blackmoor/v0.8.3_vs_v0.10_strategy.md` - Strategic context
- `docs/ROADMAP.md` - Version planning
