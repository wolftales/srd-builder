# v0.8.3 Equipment Properties & Subcategories - Implementation Plan

**Target:** Clean up weapon properties and add missing subcategories
**Effort:** 2-3 weeks
**Schema:** 1.3.0 → 1.3.1 (patch, additive changes only)
**Priority:** HIGH - Quick win, high value for consumers

---

## Problem Statement

### Current Issues

1. **Properties have embedded data** (violates DRY principle)
   ```json
   {
     "properties": ["versatile (1d10)", "thrown (range 20/60)"],
     "versatile_damage": {"dice": "1d10"},  // Data duplicated!
     "range": {"normal": 20, "long": 60}    // Data duplicated!
   }
   ```

2. **Missing weapon subcategories** (simple vs martial)
   - No way to filter weapons by complexity level
   - Can't query "give me all simple melee weapons"
   - Current: Only `weapon_type: "melee"/"ranged"`
   - Missing: simple/martial distinction

3. **Properties need normalization**
   - Current: `"versatile (1d10)"`, `"versatile (1d8)"`
   - Target: `"versatile"` (data in separate field)

---

## Current Property Inventory (from dist/srd_5_1/equipment.json)

### Properties with Embedded Data (NEEDS CLEANUP)
- `ammunition (range 25/100)` → `ammunition` (data in `range` field)
- `ammunition (range 80/320)` → `ammunition` (data in `range` field)
- `thrown (range 20/60)` → `thrown` (data in `range` field)
- `thrown (range 5/15)` → `thrown` (data in `range` field)
- `versatile (1d10)` → `versatile` (data in `versatile_damage` field)
- `versatile (1d8)` → `versatile` (data in `versatile_damage` field)

### Properties Already Clean (NO CHANGE)
- `finesse` ✅
- `heavy` ✅
- `light` ✅
- `loading` ✅
- `reach` ✅
- `special` ✅
- `two-­‐handed` ✅

---

## Implementation Plan

### Phase 1: Property Normalization (Week 1)

**Goal:** Remove embedded data from properties array

**Changes:**
1. Update `parse_equipment.py`:
   ```python
   def _normalize_properties(properties: list[str]) -> list[str]:
       """Strip embedded data from weapon properties."""
       normalized = []
       for prop in properties:
           # Remove parenthetical data
           clean_prop = re.sub(r'\s*\([^)]+\)', '', prop).strip()
           normalized.append(clean_prop)
       return normalized
   ```

2. Apply during equipment parsing (after extracting damage/range data)

3. Update tests:
   - Verify properties cleaned: `["versatile (1d10)"]` → `["versatile"]`
   - Verify data preserved: `versatile_damage` still has `"1d10"`
   - Verify range preserved: `range` still has `{normal: 20, long: 60}`

**Affected Items:** ~15-20 weapons with versatile/thrown/ammunition properties

**Schema Change:** None (properties is already `array<string>`)

---

### Phase 2: Weapon Subcategories (Week 1-2)

**Goal:** Add simple/martial distinction to weapons

**Current State:**
```json
{
  "name": "Longsword",
  "category": "weapon",
  "weapon_type": "melee",
  "sub_category": null  // Missing!
}
```

**Target State:**
```json
{
  "name": "Longsword",
  "category": "weapon",
  "weapon_type": "melee",
  "sub_category": "martial_melee"  // NEW!
}
```

**Subcategory Values:**
- `simple_melee` - Club, Dagger, Mace, Quarterstaff, etc.
- `simple_ranged` - Crossbow (light), Dart, Shortbow, Sling
- `martial_melee` - Battleaxe, Longsword, Warhammer, etc.
- `martial_ranged` - Crossbow (hand/heavy), Longbow, Net

**Implementation:**

1. **Option A: Extract from PDF table section headers** (PREFERRED)
   - SRD weapon tables have "Simple Melee Weapons", "Martial Melee Weapons" sections
   - Already captured in `section` field during extraction
   - Parse section → subcategory mapping

2. **Option B: Hardcoded lookup table** (FALLBACK)
   - If section not reliable, use weapon name → subcategory mapping
   - Based on SRD 5.1 weapon tables (pages 66-68)

**Code Changes:**
```python
# In parse_equipment.py
def _determine_weapon_subcategory(item: dict) -> str | None:
    """Determine weapon subcategory from section or name."""
    if item.get('category') != 'weapon':
        return None

    section = item.get('section', '').lower()
    weapon_type = item.get('weapon_type')

    # Try section-based detection first
    if 'simple' in section and weapon_type == 'melee':
        return 'simple_melee'
    elif 'simple' in section and weapon_type == 'ranged':
        return 'simple_ranged'
    elif 'martial' in section and weapon_type == 'melee':
        return 'martial_melee'
    elif 'martial' in section and weapon_type == 'ranged':
        return 'martial_ranged'

    # Fallback: name-based lookup (if needed)
    # return WEAPON_SUBCATEGORY_MAP.get(item['simple_name'])

    return None
```

**Tests:**
- Verify simple melee: Club, Dagger, Mace → `simple_melee`
- Verify simple ranged: Shortbow, Sling → `simple_ranged`
- Verify martial melee: Longsword, Greatsword → `martial_melee`
- Verify martial ranged: Longbow → `martial_ranged`

**Schema Change:** None (sub_category already exists, type `string | null`)

---

### Phase 3: Armor Subcategories (Week 2)

**Goal:** Normalize armor subcategories to match weapon pattern

**Current State:**
```json
{
  "name": "Chain Mail",
  "category": "armor",
  "sub_category": "heavy"  // Raw from PDF
}
```

**Options:**

**Option A: Keep as-is** (PREFERRED)
- Current values: `"light"`, `"medium"`, `"heavy"`
- Already clean, lowercase, normalized
- No change needed

**Option B: Be more explicit**
- Change to: `"light_armor"`, `"medium_armor"`, `"heavy_armor"`
- Consistency with weapon subcategories
- More verbose but clearer

**Recommendation:** Keep armor subcategories as-is (`"light"`, `"medium"`, `"heavy"`). They're already clean and don't need the suffix.

---

### Phase 4: Index Updates (Week 2)

**Goal:** Enable filtering by weapon subcategory

**Add to `indexer.py`:**
```python
def build_equipment_index(items: list[dict]) -> dict:
    by_name = {}
    by_category = defaultdict(list)
    by_subcategory = defaultdict(list)  # NEW!

    for item in items:
        item_id = item['id']
        by_name[item['simple_name']] = item_id
        by_category[item['category']].append(item_id)

        # NEW: Index by subcategory
        if subcategory := item.get('sub_category'):
            by_subcategory[subcategory].append(item_id)

    return {
        'by_name': dict(sorted(by_name.items())),
        'by_category': {k: sorted(v) for k, v in sorted(by_category.items())},
        'by_subcategory': {k: sorted(v) for k, v in sorted(by_subcategory.items())},  # NEW!
    }
```

**Index Output:**
```json
{
  "equipment": {
    "by_subcategory": {
      "simple_melee": ["item:club", "item:dagger", "item:mace", ...],
      "simple_ranged": ["item:light_crossbow", "item:shortbow", ...],
      "martial_melee": ["item:longsword", "item:greatsword", ...],
      "martial_ranged": ["item:longbow", "item:heavy_crossbow", ...],
      "light": ["item:leather_armor", "item:studded_leather", ...],
      "medium": ["item:chain_shirt", "item:scale_mail", ...],
      "heavy": ["item:chain_mail", "item:plate", ...]
    }
  }
}
```

**Benefits for Blackmoor:**
- Query: "Show me all simple melee weapons" → `index['equipment']['by_subcategory']['simple_melee']`
- Query: "Show me all martial ranged weapons" → `index['equipment']['by_subcategory']['martial_ranged']`
- Character creation: Filter weapons by proficiency (simple vs martial)

---

### Phase 5: Documentation (Week 3)

**Update `docs/DATA_DICTIONARY.md`:**

**Equipment.properties (array<string>):**
- Clean property names without embedded data
- Canonical list:
  - `ammunition` - Requires ammunition to fire
  - `finesse` - Can use Dex instead of Str for attack/damage
  - `heavy` - Small creatures have disadvantage
  - `light` - Suitable for two-weapon fighting
  - `loading` - Can only fire once per action
  - `reach` - Adds 5 feet to reach
  - `special` - See weapon description for special rules
  - `thrown` - Can be thrown (range in `range` field)
  - `two-handed` - Requires two hands to use
  - `versatile` - Can be used one or two-handed (damage in `versatile_damage` field)

**Equipment.sub_category (string | null):**
- Weapons: `simple_melee`, `simple_ranged`, `martial_melee`, `martial_ranged`
- Armor: `light`, `medium`, `heavy`
- Gear: `null` (no subcategories)

**Update `docs/SCHEMAS.md`:**
- Document property normalization approach
- Document subcategory values
- Note that embedded data removed in v0.8.3

**Update `README.md`:**
- Note v0.8.3 changes in changelog
- Update examples to use clean properties

---

## Testing Strategy

### Unit Tests
- `test_parse_equipment.py`:
  - Test property normalization (embedded data removed)
  - Test subcategory assignment (all weapons categorized)
  - Test armor subcategories (unchanged)

### Integration Tests
- `test_golden_equipment.py`:
  - Update golden fixtures with clean properties
  - Verify longsword: `properties: ["versatile"]` not `["versatile (1d10)"]`
  - Verify dagger: `properties: ["finesse", "light", "thrown"]` not `["finesse", "light", "thrown (range 20/60)"]`

### Validation Tests
- All weapons have `sub_category` (simple or martial + melee or ranged)
- All armor have `sub_category` (light, medium, or heavy)
- All properties are single words (no parentheses)
- Versatile weapons have both `properties: ["versatile"]` AND `versatile_damage` field
- Thrown weapons have both `properties: ["thrown"]` AND `range` field

---

## Schema Version

**1.3.0 → 1.3.1 (PATCH)**

**Why patch not minor:**
- No new fields added (sub_category already exists)
- Property normalization is data cleanup, not schema change
- Subcategory values are documentation, not schema constraint (no enum)
- Additive only: existing code continues to work

**Schema Changes:**
- None! Schema already supports these fields
- Documentation updates only

---

## Risks & Mitigations

### Risk: Section-based subcategory detection fails
**Mitigation:** Fallback to name-based lookup table for 100% coverage

### Risk: Property normalization loses data
**Mitigation:** Data already in separate fields (versatile_damage, range). Verify tests before/after.

### Risk: Breaking change for consumers expecting embedded data
**Mitigation:** Documented in CHANGELOG. Consumers should use structured fields (versatile_damage, range) not properties array.

---

## Success Criteria

✅ All weapon properties cleaned (no parentheses)
✅ All weapons have subcategory (simple/martial + melee/ranged)
✅ Index includes `by_subcategory` lookup
✅ 113+ tests passing
✅ Data quality unchanged (damage, range preserved in structured fields)
✅ Documentation updated (DATA_DICTIONARY.md, SCHEMAS.md)

---

## Timeline

**Week 1:**
- Day 1-2: Property normalization implementation + tests
- Day 3-4: Weapon subcategory implementation + tests
- Day 5: Integration testing, fixture updates

**Week 2:**
- Day 1-2: Index updates (by_subcategory)
- Day 3-4: Validation tests, edge case handling
- Day 5: Documentation updates

**Week 3:**
- Day 1-2: Final polish, CHANGELOG update
- Day 3-4: Build, validate, tag v0.8.3
- Day 5: Release notes, update integration guide for Blackmoor

**Total: 3 weeks (conservative estimate)**

---

## Next Steps

1. ✅ Get user approval on v0.8.3 scope
2. Implement property normalization
3. Implement weapon subcategories
4. Update indexes
5. Update documentation
6. Release v0.8.3

**Related Documents:**
- `docs/TODO.md` - Equipment section
- `docs/external/blackmoor/v0.8.3_vs_v0.10_strategy.md` - Strategic context
- `docs/ROADMAP.md` - Version planning
