# v0.9.9 Part 2 - Equipment Assembly Implementation Plan

**Date:** November 8, 2025
**Status:** READY TO START
**Prerequisites:** ✅ COMPLETE - Part 1 (30/30 tables migrated)
**Effort:** 2-3 sessions (6-8 hours)

---

## Context

**Part 1 (COMPLETE):** Migrated all 30 tables to modern patterns, archived 1313 lines of legacy code
**Part 2 (THIS DOC):** Replace PyMuPDF equipment extraction with table-based assembly

---

## Current State

### Existing equipment.json (PyMuPDF-based)
- **Source:** `extract_equipment.py` (507 lines, fragile PyMuPDF extraction)
- **Items:** 106 total (6 armor, 18 weapons, 75 gear, 7 mounts)
- **Structure:** Flat `items` array ✅ (Blackmoor-validated, programmatic-friendly)
- **Schema:** v1.4.0 (unreleased - Blackmoor on v1.3.0)

### Available tables.json (normalized tables)
- **Source:** Modern pattern-based extraction (30/30 tables)
- **Equipment tables:** 10 tables, 259+ total rows
  1. armor (13 rows)
  2. weapons (37 rows)
  3. tools (38 rows)
  4. adventure_gear (103 rows)
  5. container_capacity (13 rows)
  6. mounts_and_other_animals (8 rows)
  7. food_drink_lodging (19 rows)
  8. services (7 rows)
  9. tack_harness_vehicles (14 rows)
  10. waterborne_vehicles (6 rows)

---

## Issues to Fix

### 1. Bug: armor section/sub_category mismatch
```json
{
  "name": "Leather",
  "section": "armor:medium",      // ✗ WRONG
  "sub_category": "light"         // ✓ CORRECT
}
```
**Fix:** `sub_category` should be the source of truth (light/medium/heavy/shield)

### 2. Incomplete coverage (106 vs 259+ items)
- Missing: ~153 items from tables
- Current armor: 6 items → Should be 13
- Current weapons: 18 items → Should be 37
- Missing entirely: tools (38), services (7), most vehicles, food, etc.

### 3. Inconsistent sub_category usage
- **Armor:** Uses it ✅ (light/medium/heavy)
- **Weapons:** Doesn't use it ✗ (should be simple-melee, martial-ranged, etc.)
- **Gear:** Doesn't use it ✗ (should be container, focus, tool, etc.)

---

## Design Decisions

### 1. Pipeline: tables.json → equipment.json ✅
**Rationale:** Use normalized tables (metadata already applied), don't duplicate work

### 2. Structure: Flat items array ✅
**Rationale:** Blackmoor feedback - easier programmatic loading/searching
**Indexing:** index.json provides lookups (by_category, by_subcategory, etc.)

### 3. Category Taxonomy
```
category: weapon | armor | gear | mount | vehicle | service | consumable

sub_category (string or array of strings):
- Armor: "light" | "medium" | "heavy" | "shield"
- Weapons: "simple-melee" | "simple-ranged" | "martial-melee" | "martial-ranged"
- Tools: "artisan" | "gaming" | "musical" | "other"
- Gear: "container" | "focus" | "ammunition" | "light_source" | "climbing" | etc.
- Vehicles: "land" | "water"
- Mounts: "riding" | "pack"
```

### 4. Metadata Preservation
```json
{
  "source_table": "adventure_gear",  // NEW - which table this came from
  "page": 64,                         // KEEP - PDF page
  "section": "armor:medium",          // KEEP - original section context
  "row_index": 0                      // KEEP - position in source table
}
```

### 5. Aliases
**Maintain existing patterns:**
```json
{
  "name": "Flask or tankard",
  "aliases": ["flask", "tankard"]  // KEEP - search flexibility
}
```

**Also support value aliases** (Str → strength, handled by indexer/search)

### 6. Cross-References
**Container capacity:**
```json
{
  "name": "Backpack",
  "category": "gear",
  "sub_category": ["container", "adventuring"],
  "capacity": "1 cubic foot/30 pounds of gear",  // NEW - from container_capacity table
  "cost": {"amount": 2, "currency": "gp"},
  "weight_lb": 5.0
}
```

### 7. Text Descriptions (Phase 2 - optional)
**Add where prose exists:**
- Located near tables (pages 62-74)
- Examples: Hourglass, Spyglass have detailed descriptions
- Most items don't have descriptions (rope, torch, etc.)
- **Schema addition:** `"description": string | null`

---

## Implementation Plan

### Phase 1: Table Assembly (PRIMARY)

#### Task 1: Design assembly architecture
- [ ] Create `src/srd_builder/assemble_equipment.py` (new file)
- [ ] Design table → schema mapping for each table type
- [ ] Define subcategory inference rules

#### Task 2: Implement armor assembly
- [ ] Map armor table columns → equipment schema
- [ ] Parse AC (base + dex_bonus + max_bonus)
- [ ] Parse strength requirements
- [ ] Parse stealth disadvantage
- [ ] Infer sub_category from table categories (Light/Medium/Heavy/Shield)
- [ ] Add source_table metadata

#### Task 3: Implement weapons assembly
- [ ] Map weapons table columns → equipment schema
- [ ] Parse damage (dice + type)
- [ ] Parse properties (finesse, light, thrown, versatile, etc.)
- [ ] Parse range from properties
- [ ] Parse versatile damage
- [ ] Infer sub_category (simple-melee, martial-ranged, etc.)
- [ ] Add source_table metadata

#### Task 4: Implement tools assembly
- [ ] Map tools table columns → equipment schema
- [ ] Infer sub_category from table categories (Artisan's/Gaming/Musical)
- [ ] Handle cost/weight
- [ ] Add source_table metadata

#### Task 5: Implement adventure_gear assembly
- [ ] Map adventure_gear table columns → equipment schema
- [ ] Infer sub_category from table categories
- [ ] Cross-reference with container_capacity table
- [ ] Add capacity property where applicable
- [ ] Add source_table metadata

#### Task 6: Implement remaining tables
- [ ] mounts_and_other_animals (speed, carrying capacity)
- [ ] food_drink_lodging (simple cost mapping)
- [ ] services (simple cost mapping)
- [ ] tack_harness_vehicles (land vehicles)
- [ ] waterborne_vehicles (water vehicles)

#### Task 7: Integration
- [ ] Update build.py to use assemble_equipment.py
- [ ] Deprecate extract_equipment.py (move to archive)
- [ ] Keep schema version v1.4.0 (unreleased, can continue iterating)
- [ ] Generate equipment.json from tables

#### Task 8: Testing
- [ ] Create test_equipment_assembly.py
- [ ] Test armor assembly (all 13 items)
- [ ] Test weapons assembly (all 37 items)
- [ ] Test cross-references (container_capacity)
- [ ] Test subcategory inference
- [ ] Validate against equipment schema
- [ ] Compare item counts (should be 259+ items)

### Phase 2: Text Descriptions (OPTIONAL)

**Decision point:** After Phase 1 complete, assess priority
- [ ] Identify prose sections with item descriptions (pages 62-74)
- [ ] Design text extraction strategy
- [ ] Implement description parser
- [ ] Add descriptions where available
- [ ] Update schema (add description field)

---

## Schema Changes

### v1.4.0 (ADDITIVE - Unreleased)

**Note:** v1.4.0 not yet released (Blackmoor on v1.3.0), so we can safely add fields without version bump.

**New fields:**
```json
{
  "source_table": "adventure_gear",           // string - which table
  "capacity": "1 cubic foot",                 // string | null - for containers
  "description": "A merchant's scale..."      // string | null - prose descriptions
}
```

**Updated fields:**
```json
{
  "sub_category": "artisan" | ["container", "adventuring"]  // Allow array
}
```

**Updated enums:**
```json
{
  "category": {
    "enum": [
      "weapon", "armor", "gear", "mount",
      "vehicle",     // NEW
      "service",     // NEW
      "consumable"   // NEW (future)
    ]
  }
}
```

---

## Column Mapping Reference

### Armor Table
```
Armor → name
Cost → cost (parse "10 gp")
Armor Class (AC) → armor_class {base, dex_bonus, max_bonus}
  "11 + Dex modifier" → {base: 11, dex_bonus: true}
  "14 + Dex (max 2)" → {base: 14, dex_bonus: true, max_bonus: 2}
  "16" → {base: 16, dex_bonus: false}
Strength → strength_req (parse "Str 13")
Stealth → stealth_disadvantage (boolean from "Disadvantage")
Weight → weight_lb (parse "10 lb.")
```

### Weapons Table
```
Name → name
Cost → cost
Damage → damage {dice, type} (parse "1d8 slashing")
Weight → weight_lb
Properties → properties[] + range + versatile_damage
  "Finesse, light, thrown (range 20/60)" →
    properties: ["finesse", "light", "thrown"]
    range: {normal: 20, long: 60}
  "Versatile (1d10)" →
    versatile_damage: {dice: "1d10"}
```

### Tools Table
```
Item → name
Cost → cost
Weight → weight_lb
(Infer sub_category from table categories)
```

### Adventure Gear / Other Tables
```
Item → name
Cost → cost
Weight → weight_lb (where available)
Speed → (for mounts/vehicles)
Carrying Capacity → (for mounts)
Capacity → capacity (for containers)
```

---

## Subcategory Inference Rules

### Armor (from table categories)
```python
if category_name == "Light Armor": sub_category = "light"
elif category_name == "Medium Armor": sub_category = "medium"
elif category_name == "Heavy Armor": sub_category = "heavy"
elif item_name == "Shield": sub_category = "shield"
```

### Weapons (from table categories + properties)
```python
category_name = "Simple Melee Weapons" | "Simple Ranged Weapons" |
                "Martial Melee Weapons" | "Martial Ranged Weapons"

if "Simple" in category_name and "Melee" in category_name:
    sub_category = "simple-melee"
elif "Simple" in category_name and "Ranged" in category_name:
    sub_category = "simple-ranged"
# etc.
```

### Tools (from table categories)
```python
if "Artisan's tools" in category_name: sub_category = "artisan"
elif "Gaming set" in category_name: sub_category = "gaming"
elif "Musical instrument" in category_name: sub_category = "musical"
else: sub_category = "other"
```

### Gear (from table categories + heuristics)
```python
# From adventure_gear table categories:
if "Ammunition" in category_name: sub_category.append("ammunition")
if "Arcane focus" in category_name: sub_category.append("focus")
if "Holy symbol" in category_name: sub_category.append("holy_symbol")
if "Druidic focus" in category_name: sub_category.append("druidic_focus")

# From container_capacity cross-reference:
if item_name in container_capacity_table:
    sub_category.append("container")
```

---

## Success Criteria

### Quantitative
- ✅ 259+ items in equipment.json (vs current 106)
- ✅ 13 armor items (vs current 6)
- ✅ 37 weapon items (vs current 18)
- ✅ All 10 equipment tables represented
- ✅ All items have source_table metadata
- ✅ All armor have correct sub_category (light/medium/heavy/shield)
- ✅ All weapons have sub_category (simple-melee, martial-ranged, etc.)
- ✅ Containers have capacity property
- ✅ Schema validation passes (v1.4.0)
- ✅ All tests pass

### Qualitative
- ✅ Code is cleaner than extract_equipment.py (507 lines PyMuPDF)
- ✅ Table-based extraction is more maintainable
- ✅ Easy to add new tables in the future
- ✅ Blackmoor integration remains unchanged (flat items array)
- ✅ Index.json provides rich lookups (by_subcategory, by_source_table, etc.)

---

## Timeline

**Session 1 (2-3 hours):** Design + armor + weapons
**Session 2 (2-3 hours):** Tools + gear + cross-references
**Session 3 (2 hours):** Remaining tables + tests + integration

**Total:** 2-3 sessions, 6-8 hours

---

## Next Steps

1. ✅ Review this plan with user
2. Create `assemble_equipment.py` skeleton
3. Implement armor assembly (first test case)
4. Run tests, iterate
5. Proceed through remaining tables

---

## Questions for Discussion

1. **sub_category format:** Array `["container", "adventuring"]` or single string `"container"`?
   - Leaning toward: Allow both, normalize to array internally
2. **Container capacity format:** Keep as-is from table (`"1 cubic foot/30 pounds of gear"`) or parse?
   - Leaning toward: Keep original string, add structured parsing later if needed
3. **Description priority:** Phase 2 or defer to v0.10.0?
   - Leaning toward: Phase 2 (add where prose exists, not mandatory)
4. **Archive extract_equipment.py:** Immediately or keep as fallback?
   - Leaning toward: Archive immediately (clean break, tables are better)

---

**Ready to proceed with implementation!**
