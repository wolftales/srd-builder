# v0.17.0 Release Notes â€” Rules Dataset

**Status:** ðŸš§ In Progress
**Started:** December 21, 2024
**Target Completion:** TBD

## Implementation Plan Reference
- Plan: [docs/planning/v0.17.0_RULES_DATASET.md](../planning/v0.17.0_RULES_DATASET.md)
- Roadmap: [docs/ROADMAP.md](../ROADMAP.md) (v0.17.0 milestone)

## Objectives
1. Create `rules.json` dataset following modular pipeline pattern
2. Extract core mechanics from SRD chapters (abilities, combat, spellcasting, adventuring)
3. Use `rule:*` namespace with standard `_meta` + `items[]` schema
4. Link to existing datasets via namespaced IDs (conditions, spells, features)
5. Maintain parse â†’ postprocess separation (no all-in-one)

## Progress Tracker

### Phase 1: Schema & Foundation âœ… COMPLETE
- [x] Create schemas/rule.schema.json
- [x] Define core fields (id, name, simple_name, category, subcategory, parent_id, page, src, text[], tags, aliases, related_*)
- [x] Add schema_version 1.3.0 (additive, backward compatible)

### Phase 2: Extraction (Extract â†’ Parse â†’ Postprocess)
#### Extract Stage âœ… COMPLETE
- [x] Create src/srd_builder/extract/extract_rules.py
- [x] Define chapter scope using PAGE_INDEX (7 sections: abilities, time, movement, environment, resting, combat, spellcasting)
- [x] Capture font metadata (size, name, bold, page, bbox)
- [x] Output: text_blocks with font metadata + sections metadata
- [x] Provenance: PDF hash, pages processed, warnings

#### Parse Stage ðŸš§ STUB CREATED
- [x] Create src/srd_builder/parse/parse_rules.py (STUB - returns empty list)
- [ ] Build outline tree from font tiers and header stack
- [ ] Detect paragraph vs header distinction
- [ ] Attach page provenance
- [ ] Output: rules_outline.json (hierarchical structure)
- [ ] Return structured dict WITHOUT ids/normalization

#### Postprocess Stage âœ… FRAMEWORK COMPLETE
- [x] Create src/srd_builder/postprocess/rules.py
- [x] Implement clean_rule_record() function
- [x] Use normalize_id() from postprocess/ids.py
- [x] Use polish_text() from postprocess/text.py
- [x] Generate id (rule:*) and simple_name
- [x] Export clean_rule_record from postprocess/__init__.py
- [ ] Assign category/subcategory from outline (awaits parse implementation)
- [ ] Add lightweight tags (action, bonus_action, movement, saving_throw, advantage)
- [ ] Detect cross-refs to conditions/spells (optional)

### Phase 3: Build Integration
- [ ] Update src/srd_builder/build.py
  - [ ] Add rules extraction call
  - [ ] Add rules parsing call
  - [ ] Add rules postprocessing (map clean_rule_record)
  - [ ] Write dist/srd_5_1/data/rules.json
- [ ] Update src/srd_builder/indexer.py
  - [ ] Add rules to by_name index
  - [ ] Add by_category index
  - [ ] Add by_tag index (if tags present)
  - [ ] Register rule:* entities in unified catalog

### Phase 4: Validation
- [ ] Create tests/fixtures/srd_5_1/raw/rules.json (5-10 representative items)
- [ ] Create tests/fixtures/srd_5_1/normalized/rules.json (expected output)
- [ ] Create tests/test_golden_rules.py (parse + postprocess pipeline test)
- [ ] Update tests/test_dataset_completeness.py (add rules dataset check)
- [ ] Run pytest -q (all tests passing)
- [ ] Run make lint (ruff checks passing)

### Phase 5: Documentation
- [ ] Update docs/SCHEMAS.md (add rule.schema.json section)
- [ ] Update docs/DATA_DICTIONARY.md (add rules dataset fields)
- [ ] Update docs/INTEGRATION.md (add rules dataset consumption examples)
- [ ] Update docs/BUNDLE_README.md (add rules.json to artifact list)
- [ ] Update README.md (add rules to dataset list)

## Completed Work

### 2024-12-21 - Initial Implementation (Autonomous Session)

**Phase 1: Schema Definition** âœ… COMPLETE
- Created schemas/rule.schema.json
- Defined core data model aligned with existing patterns
- Schema version: 1.3.0 (additive, backward compatible)
- Core fields: id, name, simple_name, category, subcategory, parent_id, page, src, text[], tags, aliases, related_*

**Phase 2: Pipeline Scaffolding** ðŸš§ IN PROGRESS
- âœ… Extract stage: Created extract_rules.py
  - Uses PAGE_INDEX to identify 7 rules sections (pages 76-104)
  - Extracts text blocks with font metadata (name, size, bold, bbox)
  - Provenance tracking (PDF hash, pages processed)
  - Returns text_blocks + sections metadata
- âœ… Parse stage: Created parse_rules.py (STUB)
  - Follows modular pattern (structure only, NO normalization)
  - TODO: Implement font-based header detection
  - TODO: Build outline tree from header hierarchy
  - Currently returns empty list (prevents build errors)
- âœ… Postprocess stage: Created postprocess/rules.py
  - Implements clean_rule_record() function
  - Uses normalize_id() from shared utility (no duplication)
  - Uses polish_text() from shared utility (no duplication)
  - Generates id and simple_name
  - Polishes text arrays
  - Exported from postprocess/__init__.py

**Documentation:**
- Created docs/releases/v0.17.0_Release_Notes.md (this file)
- Added PARKING_LOT entry for page range discovery (RESOLVED via PAGE_INDEX)

**Blockers Identified:**
- Parse implementation requires font analysis patterns
- Need sample extraction to validate font metadata structure
- Build integration awaits parse implementation

## In Progress
- Parse implementation (font-based header detection, outline building)
- Build integration (awaits parse completion)
- Validation fixtures and tests

## Blocked Items
(None currently)

## Follow-Up Items
(Items discovered during implementation - see PARKING_LOT.md)

## Breaking Changes
(None - additive schema changes only)

## Testing Status
- Local: Not yet run (awaiting implementation)
- CI: Not yet run

## Architectural Notes
- Following modular pattern: Extract (PDFâ†’Raw) â†’ Parse (Structure) â†’ Postprocess (Normalize)
- Parse stage returns unnormalized dicts (NO id/simple_name generation)
- Postprocess stage uses shared utilities (normalize_id, polish_text)
- No code duplication (reuse existing patterns from monsters/spells/magic_items)
- Clear separation of concerns (parsing vs normalization)

## Validation Checklist
- [ ] All new code follows modular pattern (parse + postprocess)
- [ ] No duplicate ID generation logic (uses normalize_id)
- [ ] No duplicate text cleanup logic (uses polish_text)
- [ ] Golden test follows fixture pattern (raw â†’ parse â†’ postprocess â†’ compare)
- [ ] Schema validation passes
- [ ] Build pipeline deterministic (no timestamps)
- [ ] ruff format --check passes
- [ ] ruff check passes
- [ ] pytest -q passes
- [ ] Pre-commit hooks pass
