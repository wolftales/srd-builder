# v0.17.0 Release Notes ‚Äî Rules Dataset

**Status:** üöß In Progress
**Started:** December 21, 2024
**Target Completion:** TBD

## Implementation Plan Reference
- Plan: [docs/planning/v0.17.0_RULES_DATASET.md](../planning/v0.17.0_RULES_DATASET.md)
- Roadmap: [docs/ROADMAP.md](../ROADMAP.md) (v0.17.0 milestone)

## Objectives
1. Create `rules.json` dataset following modular pipeline pattern
2. Extract core mechanics from SRD chapters (abilities, combat, spellcasting, adventuring)
3. Use `rule:*` namespace with standard `_meta` + `items[]` schema
4. Link to existing datasets via namespaced IDs (conditions, spells, features)
5. Maintain parse ‚Üí postprocess separation (no all-in-one)

## Progress Tracker

### Phase 1: Schema & Foundation ‚úÖ COMPLETE
- [x] Create schemas/rule.schema.json
- [x] Define core fields (id, name, simple_name, category, subcategory, parent_id, page, src, text[], tags, aliases, related_*)
- [x] Add schema_version 1.3.0 (additive, backward compatible)

### Phase 2: Extraction (Extract ‚Üí Parse ‚Üí Postprocess)
#### Extract Stage ‚úÖ COMPLETE
- [x] Create src/srd_builder/extract/extract_rules.py
- [x] Define chapter scope using PAGE_INDEX (7 sections: abilities, time, movement, environment, resting, combat, spellcasting)
- [x] Capture font metadata (size, name, bold, page, bbox)
- [x] Output: text_blocks with font metadata + sections metadata
- [x] Provenance: PDF hash, pages processed, warnings

#### Parse Stage ‚úÖ COMPLETE
- [x] Create src/srd_builder/parse/parse_rules.py
- [x] Build outline tree from font tiers and header stack
- [x] Detect paragraph vs header distinction
- [x] Attach page provenance
- [x] Combine multi-line headers
- [x] Return structured dict WITHOUT ids/normalization
- **Results:** 172 rules extracted from 76 pages

#### Postprocess Stage ‚úÖ FRAMEWORK COMPLETE
- [x] Create src/srd_builder/postprocess/rules.py
- [x] Implement clean_rule_record() function
- [x] Use normalize_id() from postprocess/ids.py
- [x] Use polish_text() from postprocess/text.py
- [x] Generate id (rule:*) and simple_name
- [x] Export clean_rule_record from postprocess/__init__.py
- [ ] Assign category/subcategory from outline (awaits parse implementation)
- [ ] Add lightweight tags (action, bonus_action, movement, saving_throw, advantage)
- [ ] Detect cross-refs to conditions/spells (optional)

### Phase 3: Build Integration ‚úÖ COMPLETE
- [x] Update src/srd_builder/build.py
  - [x] Add rules extraction call
  - [x] Add rules parsing call
  - [x] Add rules postprocessing (map clean_rule_record)
  - [x] Write dist/srd_5_1/data/rules.json
- [x] Update src/srd_builder/indexer.py
  - [x] Add rules to by_name index
  - [x] Add by_category index
  - [x] Add by_subcategory index
  - [x] Register rule:* entities in unified catalog

### Phase 4: Validation ‚úÖ COMPLETE
- [x] Create tests/fixtures/srd_5_1/raw/rules.json (8 representative rules)
- [x] Create tests/fixtures/srd_5_1/normalized/rules.json (expected output)
- [x] Create tests/test_golden_rules.py (parse + postprocess pipeline test)
- [x] Update tests/test_dataset_completeness.py (add rules dataset check)
- [x] Run pytest -q (all 176 tests passing)
- [x] Run make lint (ruff checks passing)

### Phase 5: Documentation ‚úÖ COMPLETE
- [x] Update docs/SCHEMAS.md (add rule.schema.json section)
- [x] Update docs/DATA_DICTIONARY.md (add rules dataset fields)
- [x] Update docs/INTEGRATION.md (add rules dataset consumption examples)
- [x] Update docs/BUNDLE_README.md (add rules.json to artifact list)
- [x] Update README.md (add rules to dataset list)

## Completed Work

### 2024-12-22 - Parse Implementation ‚úÖ COMPLETE

**Parse Module - Fully Implemented:**
- Replaced stub with working font-based header detection
- **Font Pattern Discovery:**
  - Chapter headers: 25.9pt bold (e.g., "Using Ability Scores")
  - Section headers: 18.0pt bold (e.g., "Ability Checks")
  - Subsection headers: 13.9pt bold (e.g., "Contests")
- **Multi-line Header Handling:**
  - Combines headers split across lines in same block
  - Example: "Using Ability" + "Scores" ‚Üí "Using Ability Scores"
- **Paragraph Grouping:**
  - Associates body text with preceding headers
  - Cleans PDF artifacts (\r characters)
  - Filters by font size to prevent header leakage
- **Outline Building:**
  - Chapter ‚Üí category field
  - Section ‚Üí rule entry (or subcategory for subsections)
  - Subsection ‚Üí rule with subcategory
  - Returns unnormalized dicts (postprocess adds id/simple_name)

**Extraction Results:**
- **172 rules** extracted from 7 chapters (76 pages)
- Clean category/subcategory hierarchy
- Proper paragraph text arrays
- All 174 existing tests passing

**Resolution:** PDF was at rulesets/srd_5_1/SRD_CC_v5.1.pdf (not in raw/ subdirectory) - stub was created due to incorrect ls path assumption.

### 2024-12-21 - Initial Implementation (Autonomous Session)

**Phase 1: Schema Definition** ‚úÖ COMPLETE
- Created schemas/rule.schema.json
- Defined core data model aligned with existing patterns
- Schema version: 1.3.0 (additive, backward compatible)
- Core fields: id, name, simple_name, category, subcategory, parent_id, page, src, text[], tags, aliases, related_*

**Phase 2: Pipeline Scaffolding** ‚úÖ EXTRACTION + POSTPROCESS COMPLETE
- ‚úÖ Extract stage: Created extract_rules.py
  - Uses PAGE_INDEX to identify 7 rules sections (pages 76-104)
  - Extracts text blocks with font metadata (name, size, bold, bbox)
  - Provenance tracking (PDF hash, pages processed)
  - Returns text_blocks + sections metadata
- ‚ö†Ô∏è Parse stage: Created parse_rules.py (STUB - replaced 2024-12-22)
  - Initial stub returned empty list
  - Replaced with working implementation
- ‚úÖ Postprocess stage: Created postprocess/rules.py
  - Implements clean_rule_record() function
  - Uses normalize_id() from shared utility (no duplication)
  - Uses polish_text() from shared utility (no duplication)
  - Generates id and simple_name
  - Polishes text arrays
  - Exported from postprocess/__init__.py

**Documentation:**
- Created docs/releases/v0.17.0_Release_Notes.md (this file)
- Added PARKING_LOT entry for page range discovery (RESOLVED via PAGE_INDEX)

## Completed Work Summary

### 2024-12-22 - Build Integration & Golden Tests ‚úÖ COMPLETE

**Build Pipeline Integration:**
- Extended build.py with rules extraction, parsing, and writing
- Added _extract_raw_rules() and _load_raw_rules() functions
- Integrated rules into _write_datasets() (clean_rule_record mapping)
- Output: dist/srd_5_1/rules.json (184KB, 172 rules)

**Indexer Extension:**
- Added build_rule_index() function to indexer.py
- Created indexes: by_name, by_category, by_subcategory
- Registered rules in unified catalog (index.json)
- Updated entity statistics to include rules

**Text Cleanup Fix:**
- Issue: \r characters in output ("Ability \r Scores")
- Fix: Added clean_text() import and calls in postprocess/rules.py
- clean_text() now called before normalize_id() for all text fields
- Result: Clean output without PDF control characters

**Golden Test Implementation:**
- Created test_golden_rules.py following modular pattern
- Fixtures: 8 diverse rules (raw + normalized)
- Coverage: Multiple categories, subcategories, text structures
- Test verifies: raw ‚Üí parse ‚Üí postprocess ‚Üí normalized
- All 176 tests passing (175 existing + 1 new golden test)

### 2024-12-22 - Documentation Updates ‚úÖ COMPLETE

**Phase 5 Documentation:**
- Updated SCHEMAS.md: Added Rule Schema section with design philosophy, fields, examples
- Updated DATA_DICTIONARY.md: Added Rules Dataset section with field definitions
- Updated INTEGRATION.md: Added rules consumption examples and cross-referencing
- Updated BUNDLE_README.md: Added rules to bundle contents and index structure
- Updated README.md: Marked v0.17.0 complete in roadmap

**Validation Updates:**
- Updated test_dataset_completeness.py to check rules dataset (172 rules expected)
- Updated metadata.py to include rules in extraction_status
- All 176 tests passing

## In Progress
(None - v0.17.0 complete)

## Blocked Items
(None currently)

## Follow-Up Items
(Items discovered during implementation - see PARKING_LOT.md)

## Breaking Changes
(None - additive schema changes only)

## Testing Status
- Local: Not yet run (awaiting implementation)
- CI: Not yet run

## Architectural Notes
- Following modular pattern: Extract (PDF‚ÜíRaw) ‚Üí Parse (Structure) ‚Üí Postprocess (Normalize)
- Parse stage returns unnormalized dicts (NO id/simple_name generation)
- Postprocess stage uses shared utilities (normalize_id, polish_text)
- No code duplication (reuse existing patterns from monsters/spells/magic_items)
- Clear separation of concerns (parsing vs normalization)

## Validation Checklist
- [ ] All new code follows modular pattern (parse + postprocess)
- [ ] No duplicate ID generation logic (uses normalize_id)
- [ ] No duplicate text cleanup logic (uses polish_text)
- [ ] Golden test follows fixture pattern (raw ‚Üí parse ‚Üí postprocess ‚Üí compare)
- [ ] Schema validation passes
- [ ] Build pipeline deterministic (no timestamps)
- [ ] ruff format --check passes
- [ ] ruff check passes
- [ ] pytest -q passes
- [ ] Pre-commit hooks pass
