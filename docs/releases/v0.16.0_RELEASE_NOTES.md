# v0.16.0 Release Notes: Magic Items Dataset

**Release Date:** December 21, 2024
**Schema Version:** magic_item v1.0.0
**Items Count:** 264 magic items

## Overview

v0.16.0 adds comprehensive magic items extraction and parsing, bringing structured data for all SRD 5.1 magic items. This completes the core item datasets (mundane equipment + magic items).

## What's New

### Magic Items Dataset (`magic_items.json`)

**Extraction (extract_magic_items.py):**
- Font-based extraction using GillSans-SemiBold 12pt headers (same approach as spells)
- PDF pages 205-267 coverage
- Multi-line item name merging (e.g., "Amulet of Proof against Detection and Location")
- Metadata extraction from italic text (rarity, item type, attunement)
- Description text with font metadata preservation

**Parsing (parse_magic_items.py):**
- Rarity extraction: common, uncommon, rare, very rare, legendary, artifact, varies
- Item type detection: Armor, Weapon, Wondrous item, Potion, Ring, Rod, Scroll, Staff, Wand
- Attunement parsing:
  - `requires_attunement`: boolean flag
  - `attunement_requirements`: optional specific requirements (e.g., "by a spellcaster")
- Description segmentation into paragraph arrays
- ID and simple_name generation

**Schema (magic_item.schema.json v1.0.0):**
```json
{
  "id": "adamantine_armor",
  "name": "Adamantine Armor",
  "simple_name": "adamantine armor",
  "type": "Armor",
  "rarity": "uncommon",
  "requires_attunement": false,
  "description": [
    "This suit of armor is reinforced with adamantine..."
  ]
}
```

**Indexing:**
- `by_name`: name-based lookup
- `by_rarity`: 7 rarity tiers
- `by_type`: 18 item types
- `by_attunement`: true/false grouping

**Stats:**
- 264 magic items total
- 7 rarity tiers (artifact to common)
- 18 item types
- ~45% require attunement

## Technical Details

### Extraction Challenges

**Multi-line Names:**
- Item names like "Amulet of Proof against Detection and Location" wrap across lines
- Each line has header font (GillSans-SemiBold 12pt)
- Solution: Detect continuation patterns (ending with "and", "or", "of")
- Merge consecutive header lines before creating new item

**Column Layout:**
- PDF uses 2-column layout
- Simple text extraction produces corrupted/interleaved text
- Solution: Font-based span extraction with bounding boxes
- Parse semantic structure from font metadata

**Metadata Parsing:**
- Rarity and type appear in italic text after item name
- Attunement uses "requires attunement" phrase
- Specific requirements follow "by" keyword
- Multiple rarities for variants (e.g., "+1/+2/+3" items)

### Integration

**Build Pipeline:**
- `_extract_raw_magic_items()`: PDF → raw JSON
- `_load_raw_magic_items()`: Load raw data
- `parse_magic_items()`: Raw → structured
- `_write_datasets()`: Write magic_items.json
- `build_indexes()`: Add to index.json

**Indexer:**
- Added `build_magic_item_index()` function
- Entity index generation
- Stats tracking (total, rarities, types)
- Total entities count updated

## Testing

**Coverage:**
- 14 new tests in `test_golden_magic_items.py`
- Golden tests for known items (Adamantine Armor, Bag of Holding, etc.)
- Schema validation (all 264 items pass)
- Unique IDs and names
- Valid rarities and types
- Simple name format validation

**Test Suite:**
- 181 tests passed (14 new magic items tests)
- 5 tests skipped (same as before)
- All linting and formatting checks pass

## Data Quality

**Validation:**
- All 264 items validate against schema v1.0.0
- No duplicate IDs or names
- All descriptions non-empty
- Rarity values constrained to enum
- Item types reasonable (not empty)

**Sample Items:**
```
Adamantine Armor (uncommon, Armor)
Ammunition, +1, +2, or +3 (very rare, Weapon)
Amulet of Health (rare, Wondrous item)
Amulet of Proof against Detection and Location (uncommon, Wondrous item)
Bag of Holding (uncommon, Wondrous item)
Flame Tongue (rare, Weapon)
```

## Files Changed

**New Files:**
- `schemas/magic_item.schema.json` - Magic item schema v1.0.0
- `src/srd_builder/extract/extract_magic_items.py` - Extraction logic
- `src/srd_builder/parse/parse_magic_items.py` - Parsing logic
- `tests/test_golden_magic_items.py` - Golden tests
- `tests/fixtures/magic_items/normalized/sample_items.json` - Test fixtures
- `rulesets/srd_5_1/magic_items.json` - Generated dataset

**Modified Files:**
- `src/srd_builder/build.py` - Integration into build pipeline
- `src/srd_builder/assemble/indexer.py` - Indexing support

## Breaking Changes

None. This is a new dataset, no existing APIs changed.

## Migration Guide

**For Consumers:**

1. **Load Magic Items:**
   ```python
   import json
   data = json.load(open('dist/srd_5_1/magic_items.json'))
   items = data['items']
   ```

2. **Query by Rarity:**
   ```python
   index = json.load(open('dist/srd_5_1/index.json'))
   legendary_ids = index['magic_items']['by_rarity']['legendary']
   ```

3. **Find Attunement Items:**
   ```python
   attunement_ids = index['magic_items']['by_attunement']['True']
   ```

4. **Filter by Type:**
   ```python
   weapons = index['magic_items']['by_type']['Weapon']
   ```

## Known Limitations

1. **Rarity for Variants:**
   - Items like "Ammunition, +1, +2, or +3" have multiple rarities
   - Schema assigns single rarity (highest: very rare)
   - Future: Consider `rarity_range` field

2. **Description Paragraphs:**
   - Currently single paragraph per item
   - No clear paragraph markers in PDF
   - Future: Smarter segmentation if needed

3. **Variant Relationships:**
   - Schema has `variant_of` field (not yet populated)
   - Future: Link variants to base items

## Next Steps

**v0.17.0 - Rules Dataset:**
- Conditions (prose extraction)
- Diseases (prose extraction)
- Madness (table + prose)
- Generic rules framework

**Future Enhancements:**
- Link magic items to base equipment (variant_of)
- Extract magic item tables (rarity/value)
- Cross-reference spell effects in items
- Item set relationships

## Statistics

- **Dataset Size:** 212 KB (magic_items.json)
- **Extraction Time:** ~2 seconds
- **Parsing Time:** ~1 second
- **Total Build Time:** ~15 seconds (all datasets)
- **Test Suite Time:** ~14 seconds (181 tests)

## Contributors

- GitHub Copilot (implementation)
- wolftales (direction, review)

---

**Full Changelog:** v0.15.2...v0.16.0
