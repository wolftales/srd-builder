# v0.9.9 Equipment Modernization Plan

**Date:** November 7, 2025
**Target Release:** v0.9.9
**Status:** üö´ **BLOCKED** - Technical debt must be resolved first
**Scope:** Replace PyMuPDF extractor with table-based assembly + text description parsing

---

## üö® BLOCKING ISSUE: v0.9.8 Technical Debt

**Problem:** 15/30 tables (50%) still using legacy_parser "temporary bridge"

During v0.9.5, we built modern pattern-based architecture but only migrated 1 table (experience_by_cr to split_column).
The remaining 15 equipment tables were left on legacy_parser as a "temporary bridge" to text_table_parser.py (1255 lines).

**This became technical debt and blocks v0.9.9 equipment modernization.**

### Tables to Migrate (v0.9.8 Prerequisite)

**Simple Single-Page (8 tables):**
- ability_scores_and_modifiers (p76, 16 rows) - Two-column layout
- exchange_rates (p62, 4 rows)
- donning_doffing_armor (p64, 3 rows)
- services (p74, 5 rows)
- waterborne_vehicles (p72, 3 rows)
- trade_goods (p72, 15 rows)
- tack_harness_vehicles (p72, 14 rows)
- tools (p70, 18 rows)

**Multi-Page Tables (7 tables):**
- adventure_gear (p68-69, 49 rows)
- armor (p63-64, 14 rows)
- weapons (p65-66, 37 rows)
- container_capacity (p69-70, 7 rows)
- mounts_and_other_animals (p71-72, 13 rows)
- lifestyle_expenses (p72-73, 6 rows)
- food_drink_lodging (p73-74, 20 rows)

### v0.9.8 Migration Tasks

**Requirements before v0.9.9 can proceed:**
1. ‚¨ú Migrate all 15 tables to modern patterns (split_column or text_region)
2. ‚¨ú Delete text_table_parser.py (1255 lines of legacy code)
3. ‚¨ú Remove legacy_parser pattern type from patterns.py
4. ‚¨ú Remove @skip decorator from test_no_legacy_parser_tables()
5. ‚¨ú Validate zero behavioral change (all tables extract identically)
6. ‚¨ú Commit as v0.9.8 - Equipment Tables Migration Complete

**Hard Fence Added:**
- ‚úÖ Created `tests/test_no_legacy_code.py`
- ‚úÖ Test fails if ANY table uses legacy_parser (currently @skip'd during migration)
- ‚úÖ Progress test always runs to show migration status
- ‚úÖ Prevents this issue from recurring

**Timeline:** 2-3 sessions (6-8 hours) to clear technical debt

---

## Current State Analysis (Post v0.9.8)

### Existing Assets

**equipment_raw.json** (111 items via PyMuPDF extractor)
- ‚úÖ 6 armor items (light/medium/heavy)
- ‚úÖ 19 weapons (melee/ranged with properties)
- ‚úÖ 79 gear items (adventuring gear, tools, mounts, trade goods)
- ‚úÖ 7 mounts/vehicles
- ‚ö†Ô∏è NO descriptions (only table data)
- ‚ö†Ô∏è Fragile multi-page extraction logic

**tables_raw.json** (5 equipment tables)
```
‚úÖ armor            - 13 rows (Armor | Cost | AC | Strength | Stealth | Weight)
‚úÖ weapons          - 37 rows (Name | Cost | Damage | Weight | Properties)
‚úÖ tools            - 38 rows (Item | Cost | Weight)
‚ùå adventure_gear   - 1 row (BROKEN - captured description text fragment)
‚úÖ donning_doffing  - 3 rows (Category | Don | Doff) [reference table]
```

**Extraction Method:**
- Current: `extract_equipment.py` - 507 lines of PyMuPDF table detection
- Issues: Context tracking fragile, multi-page splits, no descriptions

---

## Goals for v0.9.9

### 1. Modernize Equipment Assembly (PRIMARY)

**Replace PyMuPDF extractor with table-based assembly**

#### Benefits:
- ‚úÖ Cleaner architecture (follow class progressions pattern)
- ‚úÖ More reliable data (tables already validated)
- ‚úÖ Easier to maintain (no multi-page tracking)
- ‚úÖ Better coverage (37 weapons vs 19 in current)
- ‚úÖ Separation of concerns (extraction vs normalization)

#### Architecture:
```
tables_raw.json (37 tables total)
    ‚Üì
equipment_tables_assembly.py (NEW)
    ‚Üì
equipment_assembled.json (150+ items from tables)
    ‚Üì
equipment_text_parser.py (NEW - Phase 2)
    ‚Üì
equipment_normalized.json (with descriptions)
```

#### Implementation:
1. Create `equipment_tables_assembly.py` (similar to class progressions)
2. Map table columns to equipment schema fields
3. Add category/subcategory inference
4. Parse complex fields (AC, damage, properties, range)
5. Deprecate `extract_equipment.py` (or keep for comparison)

---

### 2. Fix adventure_gear Table Extraction

**Current Issue:**
```json
{
  "simple_name": "adventure_gear",
  "headers": ["Item", "Cost", "Weight"],
  "rows": [
    ["to focus, tinder to ignite, and about 5 minutes for the", "‚Äî", "‚Äî"]
  ]
}
```

This captured a description fragment instead of the actual table!

**Root Cause:**
- Adventure gear table spans multiple pages (likely pages 66-68)
- Complex layout with descriptions interspersed
- Table detection missed headers or merged incorrectly

**Fix Needed:**
- Update `table_metadata.py` config for adventure_gear
- Adjust y_min, y_max, page range
- Possibly split into multiple tables if layout is complex
- OR: Extract via text parsing if table-based extraction isn't feasible

**Expected Output:**
```
adventure_gear: 50+ rows
  - Abacus | 2 gp | 2 lb.
  - Acid (vial) | 25 gp | 1 lb.
  - Alchemist's supplies | 50 gp | 8 lb.
  ...
```

---

### 3. Add Text Descriptions (SECONDARY)

**Source:** SRD PDF pages 62-73 contain prose descriptions for many items

**Examples:**
- **Armor:** "While you wear this armor, you have a +1 bonus to AC."
- **Weapons:** "A weapon that can be used to make a ranged attack has a range..."
- **Gear:** "Acid: As an action, you can splash the contents of this vial..."

**Extraction Strategy:**

#### Option A: Section-based Text Parsing
1. Use PyMuPDF text extraction with block detection
2. Identify item headings (bold, larger font)
3. Associate following paragraphs as descriptions
4. Match descriptions to items by name

#### Option B: Manual Curation
1. Extract descriptions once into YAML/JSON
2. Store in `reference_data/equipment_descriptions.json`
3. Merge during assembly phase
4. Lower priority for automation (one-time task)

**Priority:** Phase 2 (after table-based assembly working)

---

### 4. Magic Items (FUTURE - Likely v0.10.0+)

**Scope:** Pages 210-267 (57 pages!)

**Complexity:**
- ~200+ magic items with rich descriptions
- Rarity, attunement requirements
- Special abilities and mechanics
- Item types (weapon, armor, wondrous item, etc.)

**Phasing:**
- v0.9.9: Equipment foundation (mundane items)
- v0.10.0: Magic items structure (tables if any)
- v0.10.1+: Magic item descriptions (text parsing)

**Notes:**
- Magic items may NOT have tables (mostly prose)
- May require different extraction strategy
- Consider starting with index/list detection

---

## Implementation Plan

### Phase 1: Table-Based Assembly (HIGH PRIORITY)

**Goal:** Replace extract_equipment.py with table assembly

**Tasks:**
1. ‚úÖ Audit current tables (armor, weapons, tools)
2. ‚¨ú Fix adventure_gear table extraction
3. ‚¨ú Create equipment_tables_assembly.py
4. ‚¨ú Map table columns to schema fields
5. ‚¨ú Add category/subcategory inference logic
6. ‚¨ú Parse complex fields (AC, damage, properties)
7. ‚¨ú Generate equipment_assembled.json
8. ‚¨ú Validate against current equipment_raw.json
9. ‚¨ú Update build.py to use new assembly
10. ‚¨ú Update tests

**Success Criteria:**
- 150+ items extracted from tables (vs current 111)
- All armor (13 items) with correct AC parsing
- All weapons (37 items) with damage/properties
- All tools (38 items) with cost/weight
- All adventure gear (50+ items) with basic fields

---

### Phase 2: Text Description Parsing (MEDIUM PRIORITY)

**Goal:** Add prose descriptions to equipment items

**Tasks:**
1. ‚¨ú Analyze equipment page layouts (62-73)
2. ‚¨ú Identify description patterns (headers, formatting)
3. ‚¨ú Choose extraction strategy (automated vs manual)
4. ‚¨ú Create equipment_text_parser.py (if automated)
5. ‚¨ú Extract item descriptions
6. ‚¨ú Match descriptions to items by name
7. ‚¨ú Add "description" field to schema
8. ‚¨ú Merge descriptions into normalized output
9. ‚¨ú Validate description accuracy

**Success Criteria:**
- Descriptions for armor types (light/medium/heavy)
- Descriptions for common weapons
- Descriptions for adventuring gear (acid, rope, etc.)
- Proper attribution (no mismatched items)

---

### Phase 3: Magic Items (FUTURE)

**Defer to v0.10.0+** - Foundation must be solid first

---

## Technical Considerations

### Table Column Mapping

**Armor (13 rows):**
```python
Headers: ["Armor", "Cost", "Armor Class (AC)", "Strength", "Stealth", "Weight"]
Mapping:
  - Armor ‚Üí name
  - Cost ‚Üí cost (parse gold/silver/copper)
  - AC ‚Üí armor_class (parse "11 + Dex modifier", "14 + Dex (max 2)", etc.)
  - Strength ‚Üí strength_requirement (parse "Str 13", "Str 15")
  - Stealth ‚Üí stealth_disadvantage (boolean from "Disadvantage")
  - Weight ‚Üí weight (parse "10 lb.", "20 lb.")
```

**Weapons (37 rows):**
```python
Headers: ["Name", "Cost", "Damage", "Weight", "Properties"]
Mapping:
  - Name ‚Üí name
  - Cost ‚Üí cost
  - Damage ‚Üí damage.dice, damage.type (parse "1d8 slashing")
  - Weight ‚Üí weight
  - Properties ‚Üí properties[] (split "Finesse, light, thrown (range 20/60)")
      - Also parse range from properties
      - Parse versatile damage if present
```

**Tools (38 rows):**
```python
Headers: ["Item", "Cost", "Weight"]
Mapping:
  - Item ‚Üí name
  - Cost ‚Üí cost
  - Weight ‚Üí weight
  - category ‚Üí "tool" (infer)
  - subcategory ‚Üí parse from name patterns
```

**Adventure Gear (TBD - need to fix extraction):**
```python
Expected Headers: ["Item", "Cost", "Weight"]
Similar to tools mapping
```

### Subcategory Inference

**Armor:**
- Light: Padded, Leather, Studded leather
- Medium: Hide, Chain shirt, Scale mail, Breastplate, Half plate
- Heavy: Ring mail, Chain mail, Splint, Plate
- Shield: Shield (special case)

**Weapons:**
- Simple Melee: Club, Dagger, Greatclub, Handaxe, etc.
- Simple Ranged: Light crossbow, Dart, Shortbow, Sling
- Martial Melee: Battleaxe, Flail, Glaive, Greatsword, etc.
- Martial Ranged: Blowgun, Hand crossbow, Heavy crossbow, Longbow

**Tools:**
- Artisan's tools: Alchemist's supplies, Brewer's supplies, etc.
- Gaming sets: Dice set, Playing card set
- Musical instruments: Bagpipes, Drum, Flute, etc.
- Other tools: Navigator's tools, Thieves' tools, Vehicles (land/water)

**Gear:**
- Adventuring: Backpack, Bedroll, Rope, Torch, etc.
- Containers: Barrel, Basket, Bottle, Chest, etc.
- Equipment Packs: Burglar's Pack, Diplomat's Pack, etc.

---

## Schema Changes

### Current Schema (v1.2.0)

```json
{
  "name": "Longsword",
  "category": "weapon",
  "subcategory": "martial_melee",
  "cost": {"gp": 15},
  "weight": {"lb": 3.0, "raw": "3 lb."},
  "damage": {
    "dice": "1d8",
    "type": "slashing",
    "versatile_dice": "1d10"
  },
  "properties": ["versatile"],
  "range": {"normal": 20, "long": 60}
}
```

### Proposed Schema (v1.3.0)

```json
{
  "name": "Longsword",
  "category": "weapon",
  "subcategory": "martial_melee",
  "cost": {"gp": 15},
  "weight": {"lb": 3.0, "raw": "3 lb."},
  "damage": {
    "dice": "1d8",
    "type": "slashing",
    "versatile_dice": "1d10"
  },
  "properties": ["versatile"],
  "range": {"normal": 20, "long": 60},
  "description": "A versatile sword usable with one or two hands.",
  "source": {
    "book": "SRD 5.1",
    "page": 65,
    "table": "weapons"
  }
}
```

**Changes:**
- Add optional `description` field (Phase 2)
- Add optional `source` field for traceability
- Consider `proficiency_required` field for tools

---

## Migration Path

### Comparison Phase
1. Generate equipment from BOTH extractors
2. Compare outputs (items, fields, values)
3. Document discrepancies
4. Fix table-based assembly until parity achieved

### Validation Phase
1. Run existing equipment tests
2. Add new tests for table assembly
3. Verify item counts match or exceed
4. Spot-check critical items (armor AC, weapon damage)

### Cutover Phase
1. Update build.py to use table assembly
2. Deprecate extract_equipment.py (keep for reference)
3. Update documentation
4. Tag v0.9.9

---

## Questions for Discussion

1. **adventure_gear table:** Should we fix extraction or parse from text?
   - Fixing extraction = cleaner, more maintainable
   - Text parsing = might be only option if layout is too complex

2. **Description priority:** Automate or manual curation?
   - Automated = scalable, good for magic items later
   - Manual = faster for one-time mundane equipment

3. **Magic items scope:** Start structure in v0.9.9 or defer to v0.10.0?
   - Start = get foundation right early
   - Defer = don't bloat v0.9.9 scope

4. **extract_equipment.py:** Delete or keep for comparison?
   - Delete = cleaner codebase
   - Keep = useful for validation, reference

5. **Equipment packs:** These are containers with lists of items inside
   - Extract as items with `contains: []` field?
   - Or separate equipment_packs.json?

---

## Success Metrics

### v0.9.8 Complete When:
- ‚úÖ All 15 tables migrated to modern patterns
- ‚úÖ Zero tables using legacy_parser
- ‚úÖ text_table_parser.py deleted
- ‚úÖ test_no_legacy_parser_tables() passes (without @skip)
- ‚úÖ All tables extract with same row counts (zero behavioral change)

### v0.9.9 Complete When:
- ‚úÖ 150+ equipment items extracted from modernized tables
- ‚úÖ All table-based items have correct fields
- ‚úÖ Table assembly replaces PyMuPDF extractor
- ‚úÖ Text descriptions added from prose (pages 62-74)
- ‚úÖ Schema updated to v1.6.0 (description field)
- ‚úÖ Tests passing with new architecture
- ‚úÖ equipment.json is now comprehensive dataset built from quality tables

### Stretch Goals (v0.10.0+):
- Magic item structure exploration
- Equipment pack container modeling
- Cross-references to spells/monsters

---

## Timeline Estimate

**v0.9.8 (Technical Debt):** 2-3 sessions (6-8 hours)
- Migrate 15 tables to modern patterns
- Delete legacy code
- Validate zero behavioral change

**v0.9.9 Phase 1 (Table Assembly):** 1-2 sessions (3-4 hours)
- Create equipment_tables_assembly.py
- Map table columns to equipment schema
- Generate equipment.json from modernized tables
- Validate against current 106-item output

**v0.9.9 Phase 2 (Descriptions):** 1-2 sessions (3-4 hours)
- Extract text descriptions from equipment section
- Match descriptions to items by name/aliases
- Add description field to schema
- Merge into equipment.json

**Phase 3 (Magic Items):** 3-5 sessions (FUTURE v0.10.0+)
- Large scope (200+ items, pages 210-267)
- Complex descriptions and mechanics
- Defer until mundane equipment foundation is solid

**Total Timeline:**
- **v0.9.8:** 6-8 hours (PREREQUISITE - blocks v0.9.9)
- **v0.9.9:** 6-8 hours (after v0.9.8 complete)
- **Combined:** 4-7 sessions (~12-16 hours)

---

## Next Steps

1. **Audit adventure_gear pages** - Identify why table extraction failed
2. **Create equipment_tables_assembly.py** - Start with armor/weapons/tools
3. **Test against current output** - Ensure parity or improvement
4. **Fix adventure_gear extraction** - Update table_metadata.py config
5. **Add description parsing** - Phase 2 implementation
6. **Document and release** - v0.9.9 tag and ROADMAP update

---

**Ready to proceed? Let's modernize equipment! üõ°Ô∏è‚öîÔ∏è**
