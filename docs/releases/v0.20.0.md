# Release v0.20.0 - Atomic Reference Datasets

**Release Date:** December 23, 2025
**Package Version:** 0.20.0
**Breaking Changes:** No
**New Datasets:** 4

## Overview

This release introduces **4 new atomic reference datasets** that extract fundamental D&D game constants from prose and tables into standalone, cross-referenceable JSON files. These atomic datasets provide the building blocks for future cross-reference validation and enable external consumers to validate their own data against official SRD definitions.

## New Datasets

### 1. damage_types.json (13 items)

**Schema:** `damage_type.schema.json` v1.0.0
**Size:** 5.2 KB
**Source:** SRD 5.1 page 97 (Damage Types section)

The 13 canonical D&D damage types with descriptions and examples:

- **Physical:** Bludgeoning, Piercing, Slashing
- **Elemental:** Acid, Cold, Fire, Lightning, Thunder
- **Exotic:** Force, Necrotic, Poison, Psychic, Radiant

**Schema:**
```json
{
  "id": "damage_type:fire",
  "simple_name": "fire",
  "name": "Fire",
  "description": [
    "Fire damage represents burning, heat, and flames.",
    "Fire elementals breathe fire, and many spells conjure flames."
  ],
  "examples": ["red dragon breath", "flame tongue weapon", "fireball spell"],
  "page": 97,
  "source": "SRD 5.1"
}
```

**Use Cases:**
- Validate `damage.type_id` references in monsters, spells, items
- Populate damage type dropdowns in character builders
- Cross-reference resistance/immunity/vulnerability mechanics

---

### 2. ability_scores.json (6 items)

**Schema:** `ability_score.schema.json` v1.0.0
**Size:** 2.8 KB
**Source:** SRD 5.1 pages 76-77 (Using Ability Scores section)

The 6 core D&D ability scores with descriptions and skill associations:

- Strength (STR) - Athletics
- Dexterity (DEX) - Acrobatics, Sleight of Hand, Stealth
- Constitution (CON) - No associated skills
- Intelligence (INT) - Arcana, History, Investigation, Nature, Religion
- Wisdom (WIS) - Animal Handling, Insight, Medicine, Perception, Survival
- Charisma (CHA) - Deception, Intimidation, Performance, Persuasion

**Schema:**
```json
{
  "id": "ability:strength",
  "simple_name": "strength",
  "abbreviation": "STR",
  "name": "Strength",
  "description": [
    "Strength measures bodily power, athletic training, and the extent to which you can exert raw physical force."
  ],
  "skills": ["skill:athletics"],
  "page": 76,
  "source": "SRD 5.1"
}
```

**Use Cases:**
- Validate ability references in saving throws, spells, class features
- Display ability-skill relationships in character sheets
- Generate ability modifier calculations

---

### 3. skills.json (18 items)

**Schema:** `skill.schema.json` v1.0.0
**Size:** 11 KB
**Source:** SRD 5.1 pages 77-78 (Using Ability Scores section)

All 18 D&D skills with their governing abilities and descriptions:

**Strength:** Athletics
**Dexterity:** Acrobatics, Sleight of Hand, Stealth
**Intelligence:** Arcana, History, Investigation, Nature, Religion
**Wisdom:** Animal Handling, Insight, Medicine, Perception, Survival
**Charisma:** Deception, Intimidation, Performance, Persuasion

**Schema:**
```json
{
  "id": "skill:athletics",
  "simple_name": "athletics",
  "name": "Athletics",
  "ability": "strength",
  "ability_id": "ability:strength",
  "description": [
    "Your Strength (Athletics) check covers difficult situations you encounter while climbing, jumping, or swimming."
  ],
  "page": 77,
  "source": "SRD 5.1"
}
```

**Use Cases:**
- Validate skill proficiencies in character classes/backgrounds
- Populate skill selection interfaces
- Cross-reference ability-skill relationships

---

### 4. weapon_properties.json (11 items)

**Schema:** `weapon_property.schema.json` v1.0.0
**Size:** 8.1 KB
**Source:** SRD 5.1 page 66 (Weapon Properties section)

The 11 weapon properties that modify weapon behavior:

Ammunition, Finesse, Heavy, Light, Loading, Range, Reach, Special, Thrown, Two-Handed, Versatile

**Schema:**
```json
{
  "id": "weapon_property:versatile",
  "simple_name": "versatile",
  "name": "Versatile",
  "description": [
    "This weapon can be used with one or two hands. A damage value in parentheses appears with the property—the damage when the weapon is used with two hands to make a melee attack."
  ],
  "page": 66,
  "source": "SRD 5.1"
}
```

**Use Cases:**
- Validate weapon property references in equipment.json
- Display property tooltips in item browsers
- Implement weapon mechanic calculations

---

## Quality Improvements

### Security ✅
- **Zero vulnerabilities:** pip-audit reports 0 known security issues
- All dependencies up-to-date and secure

### Test Coverage ✅
- **80% overall coverage** (up from 78%)
- **278 tests** (up from 231, +47 new tests)
- **100% pass rate**

**New Test Modules:**
- `test_parse_madness.py` - 12 tests (0% → 100% coverage)
- `test_parse_madness_tables.py` - 12 tests (0% → 100% coverage)
- `test_parse_poison_descriptions.py` - 13 tests (0% → 100% coverage)
- `test_parse_poisons.py` - 22 tests (0% → 96% coverage)

### Type Safety ✅
- **Strict type checking enabled:** `disallow_untyped_defs = true`
- **0 type errors** in production code
- Added type annotations to 8 previously untyped functions:
  - `extract_magic_items.main()`
  - `parse_rules.main()`
  - `parse_magic_items.main()`
  - `extract_rules.__post_init__()` and `main()`
  - `postprocess/rules.main()`
  - `extract_conditions.main()`
  - `build.get_sort_page()`

---

## Dataset Summary

**Total Datasets:** 17 (13 existing + 4 new)
**Total Items:** 1,548 (1,500 existing + 48 new)

| Dataset | Items | Schema | Size |
|---------|-------|--------|------|
| **NEW: damage_types** | 13 | v1.0.0 | 5.2 KB |
| **NEW: ability_scores** | 6 | v1.0.0 | 2.8 KB |
| **NEW: skills** | 18 | v1.0.0 | 11 KB |
| **NEW: weapon_properties** | 11 | v1.0.0 | 8.1 KB |
| monsters | 317 | v2.0.0 | 1.9 MB |
| equipment | 111 | v2.0.0 | 107 KB |
| spells | 319 | v2.0.0 | 464 KB |
| classes | 12 | v2.0.0 | 99 KB |
| conditions | 15 | v2.0.0 | 15 KB |
| diseases | 3 | v2.0.0 | 4.5 KB |
| features | 246 | v2.0.0 | 259 KB |
| lineages | 13 | v2.0.0 | 41 KB |
| magic_items | 240 | v2.0.0 | 306 KB |
| poisons | 14 | v2.0.0 | 17 KB |
| rules | 172 | v2.0.0 | 231 KB |
| tables | 38 | v2.0.0 | 108 KB |

---

## Technical Implementation

### Schema Files Created
- `schemas/damage_type.schema.json` (v1.0.0)
- `schemas/ability_score.schema.json` (v1.0.0)
- `schemas/skill.schema.json` (v1.0.0)
- `schemas/weapon_property.schema.json` (v1.0.0)

### Parsers Created
Static data parsers (no PDF extraction needed):
- `src/srd_builder/parse/parse_damage_types.py`
- `src/srd_builder/parse/parse_ability_scores.py`
- `src/srd_builder/parse/parse_skills.py`
- `src/srd_builder/parse/parse_weapon_properties.py`

### Postprocessors Created
- `src/srd_builder/postprocess/damage_types.py`
- `src/srd_builder/postprocess/ability_scores.py`
- `src/srd_builder/postprocess/skills.py`
- `src/srd_builder/postprocess/weapon_properties.py`

### Golden Tests Created
- `tests/test_golden_damage_types.py` (4 tests)
- `tests/test_golden_ability_scores.py` (5 tests)
- `tests/test_golden_skills.py` (5 tests)
- `tests/test_golden_weapon_properties.py` (4 tests)

### Test Fixtures Created
- `tests/fixtures/srd_5_1/normalized/damage_types.json`
- `tests/fixtures/srd_5_1/normalized/ability_scores.json`
- `tests/fixtures/srd_5_1/normalized/skills.json`
- `tests/fixtures/srd_5_1/normalized/weapon_properties.json`

### Build Integration
Updated `src/srd_builder/build.py`:
- Imported 4 new parsers and postprocessors
- Extended `_write_datasets()` signature with 4 new parameters
- Added 4 dataset file writes to output directory
- Integrated into main `build()` pipeline

---

## Migration Impact

### For Consumers

**No Breaking Changes** - All existing datasets remain unchanged. New atomic datasets are purely additive.

**New Capabilities:**
1. **Cross-reference validation** - Validate type_id fields against official definitions
2. **Dropdown population** - Use official lists for UI components
3. **Relationship mapping** - Leverage ability-skill associations
4. **Canonical definitions** - Reference official SRD descriptions

**Example Usage:**
```python
import json

# Load atomic dataset
with open('damage_types.json') as f:
    damage_types = json.load(f)

# Build lookup
type_lookup = {dt['id']: dt for dt in damage_types['items']}

# Validate monster damage type references
for monster in monsters['items']:
    for action in monster.get('actions', []):
        if 'damage' in action:
            type_id = action['damage']['type_id']
            assert type_id in type_lookup, f"Invalid damage type: {type_id}"
```

### For Contributors

**New Pattern Established:**
- Atomic datasets for game constants extracted from prose
- Static data parsers (no PDF extraction needed when data is enumerable)
- Comprehensive golden tests with fixture validation
- Schema version 1.0.0 for initial atomic dataset releases

---

## Future Enhancements (v0.21+)

These atomic datasets enable future cross-reference validation features:

### v0.21.0: Cross-Reference Validation
```python
def validate_damage_types(datasets):
    """Verify all damage.type_id references exist in damage_types.json"""
    damage_type_ids = {dt['id'] for dt in datasets['damage_types']['items']}

    for monster in datasets['monsters']['items']:
        for action in monster.get('actions', []):
            if 'damage' in action:
                type_id = action['damage'].get('type_id')
                assert type_id in damage_type_ids, \
                    f"{monster['name']}: Invalid damage type {type_id}"
```

### Future Atomic Datasets
- **schools.json** - 8 schools of magic (abjuration, evocation, etc.)
- **conditions.json expansion** - Add cross-references from existing conditions dataset
- **armor_types.json** - Light/medium/heavy armor categories
- **sizes.json** - Creature sizes (Tiny through Gargantuan)

---

## Testing

- ✅ 278 tests passing
- ✅ 19 tests skipped
- ✅ 80% code coverage
- ✅ All ruff checks passing
- ✅ All mypy checks passing (strict mode)
- ✅ All golden fixtures validated

---

## Files Changed

### Documentation
- `docs/V0.20.0_PLAN.md` - Consolidated v0.20 planning document
- `docs/SCHEMAS.md` - Added 4 new schema sections
- `docs/DATA_DICTIONARY.md` - Added 4 new dataset sections

### Configuration
- `pyproject.toml` - Enabled `disallow_untyped_defs = true`

### Type Annotations (8 functions)
- `src/srd_builder/extract/extract_magic_items.py`
- `src/srd_builder/extract/extract_rules.py` (2 functions)
- `src/srd_builder/extract/extract_conditions.py`
- `src/srd_builder/parse/parse_rules.py`
- `src/srd_builder/parse/parse_magic_items.py`
- `src/srd_builder/postprocess/rules.py`
- `src/srd_builder/build.py`

---

## Performance

**Build Time:** No significant change (atomic datasets are small static files)
**Output Size:** +27 KB total (+0.8% increase)

---

## Acknowledgments

This release establishes the foundation for comprehensive cross-reference validation in v0.21+, bringing srd-builder's type system one step closer to complete referential integrity.

The v0.20 development cycle focused on quality over quantity - improving test coverage, type safety, and establishing patterns for future atomic dataset extractions.

---

## Next Steps

**v0.21.0 Roadmap:**
- Implement build-time cross-reference validation
- Add remaining atomic datasets (schools, sizes, armor types)
- Extend existing datasets with type_id cross-references
- Create comprehensive validation suite

**v1.0.0 Goals:**
- 100% SRD coverage
- Complete cross-reference network
- Stable API with semantic versioning guarantees
