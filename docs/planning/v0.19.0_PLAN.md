# v0.19.0 Implementation Plan — Structural Improvements

**Status:** Draft
**Target:** Pre-v1.0 Enhancement Release
**Type:** Breaking Changes (v2.0 preview features)
**Based On:** API Structure Analysis (dnd5eapi.co, 5e-bits, Open5e)

---

## Executive Summary

v0.19.0 restructures core datasets to align with proven API patterns while maintaining srd-builder's file-based simplicity. This release focuses on **Option B (Moderate)** improvements:

1. **Nest complex fields** (speed, senses, armor_class) as objects
2. **Add structured action fields** (attack_bonus, damage parsing)
3. **Add type_id cross-references** (damage types, conditions, abilities)
4. **Add schema_version metadata** to all datasets

These changes prepare the groundwork for v1.0 stability and optional v2.0 REST API compatibility.

---

## Research Findings Summary

### What We Learned from API Analysis

**Pattern 1: Hybrid Flat+Nested**
- Ability scores (STR/DEX/CON/INT/WIS/CHA): Always flat at root ✅
- Complex fields (speed, senses, AC): Always nested objects ⚠️
- Arrays (actions, traits): Always structured with metadata ⚠️

**Pattern 2: Description + Structure Duality**
- Never choose prose OR structure — provide both
- Human-readable `description` field + queryable structured fields
- Example: Actions have `desc` + `attack_bonus` + `damage_dice`

**Pattern 3: Cross-Reference Objects**
- dnd5eapi.co/5e-bits: Rich `{index, name, url}` objects
- Open5e: Simple strings with consistent formatting
- **srd-builder choice:** Add `type_id` fields, keep string readability

### Current State vs Industry Standard

| Feature | Current (v0.18.1) | Industry (Both APIs) | Gap |
|---------|-------------------|---------------------|-----|
| Ability scores | Flat ✅ | Flat ✅ | ✅ Match |
| Speed | String ❌ | Nested object | ⚠️ Fix |
| Senses | String ❌ | Nested object | ⚠️ Fix |
| Armor Class | String/number ❌ | Structured object | ⚠️ Fix |
| Actions | Desc-only ❌ | Desc + structured | ⚠️ Fix |
| Skills | Nested ✅ | Nested ✅ | ✅ Match |
| Proficiencies | Split ✅ | Split ✅ | ✅ Match |

---

## Scope: What's Changing

### High Priority (Breaking Changes)

#### 1. Speed → Nested Object
**Current:**
```json
{
  "speed": "30 ft., swim 60 ft."
}
```

**v0.19.0:**
```json
{
  "speed": {
    "walk": 30,
    "swim": 60,
    "fly": 0,
    "burrow": 0,
    "climb": 0,
    "hover": false,
    "notes": ""
  }
}
```

**Files Affected:** monsters.json, npcs.json, creatures.json
**Parser:** `parse_monsters.py` speed parsing logic
**Schema:** monster.schema.json speed property

---

#### 2. Senses → Nested Object
**Current:**
```json
{
  "senses": "darkvision 60 ft., passive Perception 12"
}
```

**v0.19.0:**
```json
{
  "senses": {
    "darkvision": 60,
    "blindsight": 0,
    "tremorsense": 0,
    "truesight": 0,
    "passive_perception": 12,
    "notes": ""
  }
}
```

**Files Affected:** monsters.json, npcs.json, creatures.json
**Parser:** `parse_monsters.py` senses parsing logic
**Schema:** monster.schema.json senses property

---

#### 3. Armor Class → Structured Object
**Current (mixed formats):**
```json
{
  "armor_class": "17 (natural armor)"
}
// or
{
  "armor_class": 13
}
```

**v0.19.0:**
```json
{
  "armor_class": {
    "base": 17,
    "source": "natural armor",
    "with_shield": null,
    "with_mage_armor": null,
    "notes": ""
  }
}
```

**Files Affected:** monsters.json, npcs.json, creatures.json
**Parser:** `parse_monsters.py` AC parsing logic
**Schema:** monster.schema.json armor_class property

---

#### 4. Actions → Add Structured Fields
**Current:**
```json
{
  "actions": [
    {
      "name": "Bite",
      "description": "Melee Weapon Attack: +5 to hit, reach 5 ft., one target. Hit: 7 (1d6 + 3) piercing damage."
    }
  ]
}
```

**v0.19.0:**
```json
{
  "actions": [
    {
      "name": "Bite",
      "description": "Melee Weapon Attack: +5 to hit, reach 5 ft., one target. Hit: 7 (1d6 + 3) piercing damage.",
      "attack_bonus": 5,
      "damage_dice": "1d6+3",
      "damage_average": 7,
      "damage_types": ["piercing"],
      "reach": 5,
      "range": null,
      "dc": null
    }
  ]
}
```

**Files Affected:** monsters.json, npcs.json, creatures.json
**Parser:** New `parse_actions.py` module (extract structured data)
**Schema:** monster.schema.json actions items

---

### Medium Priority (Additive Changes)

#### 5. Cross-Reference type_id Fields
**Current:**
```json
{
  "damage_resistances": ["cold", "fire"],
  "damage_immunities": ["poison"],
  "condition_immunities": ["charmed", "frightened"]
}
```

**v0.19.0:**
```json
{
  "damage_resistances": [
    {
      "type": "cold",
      "type_id": "cold",
      "conditions": null
    },
    {
      "type": "bludgeoning, piercing, and slashing from nonmagical attacks",
      "type_id": "bludgeoning",
      "conditions": "nonmagical"
    }
  ],
  "damage_immunities": [
    {
      "type": "poison",
      "type_id": "poison",
      "conditions": null
    }
  ],
  "condition_immunities": [
    {
      "condition": "charmed",
      "condition_id": "charmed"
    },
    {
      "condition": "frightened",
      "condition_id": "frightened"
    }
  ]
}
```

**Files Affected:** All monster datasets, spells.json
**Parser:** New `postprocess_cross_refs.py` module
**Schema:** All schemas with cross-reference fields

---

#### 6. Schema Version Metadata
**Current (partial):**
```json
{
  "source": "SRD 5.1"
}
```

**v0.19.0:**
```json
{
  "source": "SRD 5.1",
  "schema_version": "2.0.0",
  "data_version": "0.19.0",
  "extracted_at": "2025-12-22T18:30:00Z",
  "index": "aboleth"
}
```

**Files Affected:** All datasets
**Parser:** `assemble/` modules add metadata
**Schema:** All schemas add metadata fields

---

## Implementation Strategy

### Phase 1: Schema Updates (Week 1)
**Goal:** Update all JSON schemas to v2.0.0 with new structures

**Tasks:**
1. Update `monster.schema.json`:
   - Speed object definition
   - Senses object definition
   - Armor class object definition
   - Action structured fields
   - Cross-reference type_id arrays
   - Metadata fields

2. Create migration examples:
   - Aboleth (complex monster with legendary actions)
   - Goblin (simple monster)
   - Adult Red Dragon (high CR with multiple damage types)

3. Validate examples:
   ```bash
   pytest tests/test_schema_v2_examples.py -v
   ```

**Deliverables:**
- [ ] schemas/monster.schema.json v2.0.0
- [ ] docs/examples/monster_v2_aboleth.json
- [ ] docs/examples/monster_v2_goblin.json
- [ ] docs/examples/monster_v2_adult_red_dragon.json
- [ ] tests/test_schema_v2_examples.py

---

### Phase 2: Parser Updates (Week 2)
**Goal:** Update parsers to generate v2.0 structures

**Tasks:**
1. Create new parser modules:
   ```
   src/srd_builder/parse/
   ├── parse_speed.py         # Extract walk/swim/fly/etc
   ├── parse_senses.py        # Extract darkvision/blindsight/etc
   ├── parse_armor_class.py   # Extract AC base + source
   └── parse_actions.py       # Extract attack bonus, damage, DC
   ```

2. Update existing parsers:
   ```python
   # parse_monsters.py
   from .parse_speed import parse_speed_object
   from .parse_senses import parse_senses_object
   from .parse_armor_class import parse_ac_object
   from .parse_actions import parse_action_structured

   monster["speed"] = parse_speed_object(raw_speed)
   monster["senses"] = parse_senses_object(raw_senses)
   monster["armor_class"] = parse_ac_object(raw_ac)
   monster["actions"] = [parse_action_structured(a) for a in raw_actions]
   ```

3. Test parser outputs:
   ```bash
   pytest tests/test_parse_speed.py -v
   pytest tests/test_parse_senses.py -v
   pytest tests/test_parse_armor_class.py -v
   pytest tests/test_parse_actions.py -v
   ```

**Deliverables:**
- [ ] src/srd_builder/parse/parse_speed.py + tests
- [ ] src/srd_builder/parse/parse_senses.py + tests
- [ ] src/srd_builder/parse/parse_armor_class.py + tests
- [ ] src/srd_builder/parse/parse_actions.py + tests
- [ ] Updated parse_monsters.py using new modules

---

### Phase 3: Cross-Reference Postprocessing (Week 3)
**Goal:** Add type_id fields to all cross-references

**Tasks:**
1. Create atomic reference datasets:
   ```
   dist/srd_5_1/data/
   ├── damage_types.json      # 13 damage types (acid, fire, etc)
   ├── conditions.json        # 15 conditions (exists, enhance)
   ├── ability_scores.json    # 6 abilities (STR, DEX, etc)
   └── skills.json            # 18 skills (Perception, Stealth, etc)
   ```

2. Create postprocessor:
   ```python
   # postprocess/postprocess_cross_refs.py
   def add_type_ids(monster, damage_types_index):
       """Add type_id fields to damage resistances/immunities."""
       for resistance in monster.get("damage_resistances", []):
           resistance["type_id"] = match_damage_type(
               resistance["type"],
               damage_types_index
           )
   ```

3. Integrate into pipeline:
   ```python
   # assemble/assemble_monsters.py
   from ..postprocess.postprocess_cross_refs import add_type_ids

   damage_types = load_damage_types_index()
   for monster in monsters:
       add_type_ids(monster, damage_types)
   ```

**Deliverables:**
- [ ] dist/srd_5_1/data/damage_types.json
- [ ] dist/srd_5_1/data/skills.json
- [ ] dist/srd_5_1/data/ability_scores.json
- [ ] postprocess/postprocess_cross_refs.py + tests
- [ ] Updated assemble modules with cross-ref postprocessing

---

### Phase 4: Golden Test Updates (Week 4)
**Goal:** Update all golden tests to expect v2.0 structure

**Tasks:**
1. Regenerate golden fixtures:
   ```bash
   python scripts/regenerate_golden_fixtures.py --version 2.0
   ```

2. Update test assertions:
   ```python
   # tests/test_golden_monsters.py
   def test_aboleth_structure_v2(aboleth):
       assert isinstance(aboleth["speed"], dict)
       assert "walk" in aboleth["speed"]
       assert "swim" in aboleth["speed"]

       assert isinstance(aboleth["senses"], dict)
       assert "darkvision" in aboleth["senses"]
       assert "passive_perception" in aboleth["senses"]

       assert isinstance(aboleth["armor_class"], dict)
       assert "base" in aboleth["armor_class"]
       assert "source" in aboleth["armor_class"]

       for action in aboleth["actions"]:
           assert "description" in action
           if "attack_bonus" in action:
               assert isinstance(action["attack_bonus"], int)
   ```

3. Run full test suite:
   ```bash
   pytest tests/test_golden_*.py -v
   pytest tests/test_schema_*.py -v
   pytest -q  # Full suite
   ```

**Deliverables:**
- [ ] Updated golden fixtures (monsters, npcs, creatures)
- [ ] Updated test_golden_monsters.py
- [ ] Updated test_golden_spells.py (cross-ref type_ids)
- [ ] Updated test_golden_equipment.py
- [ ] All tests passing

---

### Phase 5: Documentation & Release (Week 5)
**Goal:** Document changes and release v0.19.0

**Tasks:**
1. Update ARCHITECTURE.md:
   - New nested object patterns
   - Cross-reference postprocessing
   - Schema versioning strategy

2. Create release notes:
   ```markdown
   # v0.19.0 Release Notes

   **⚠️ BREAKING CHANGES**

   This release restructures core data fields to align with industry-standard
   API patterns observed in dnd5eapi.co, 5e-bits, and Open5e. These changes
   improve data quality, queryability, and consistency across all datasets.

   ## What Changed

   ### Field Restructuring
   - **Speed:** String → Nested object with explicit movement types
   - **Senses:** String → Nested object with explicit sense ranges
   - **Armor Class:** Mixed format → Structured object with base/source
   - **Actions:** Added structured fields (attack_bonus, damage_dice, reach, etc)
   - **Cross-references:** Added type_id fields for all damage types, conditions

   ### New Metadata
   - All entities now include schema_version, data_version, extracted_at
   - Unique index field for consistent referencing

   ## Consumer Impact

   If you consume srd-builder JSON files directly, you **will need to update**
   your code to handle the new nested object structures. See the examples
   in docs/v0.19.0_PLAN.md for before/after transformations.

   ## Rationale

   These changes align with proven patterns from major D&D APIs and improve:
   - **Queryability:** Structured fields enable filtering (e.g., "all creatures with swim speed > 40")
   - **Type Safety:** Cross-reference type_ids enable validation
   - **Consistency:** Same structure across all 317 monsters, 95 creatures, 21 NPCs
   - **Future-Proofing:** Compatible with potential REST API (v2.0+)
   ```

3. Update CHANGELOG:
   - Add v0.19.0 section with detailed breaking changes
   - Include migration examples for each changed field
   - Reference API structure analysis document

**Deliverables:**
- [ ] docs/CHANGELOG_v0.19.0.md
- [ ] Updated docs/ARCHITECTURE.md
- [ ] Updated README.md (note breaking changes)
- [ ] Git tag v0.19.0 with release notes

---

## Testing Strategy

### Unit Tests
```python
# Test each new parser module
tests/test_parse_speed.py          # 20+ test cases
tests/test_parse_senses.py         # 20+ test cases
tests/test_parse_armor_class.py    # 15+ test cases
tests/test_parse_actions.py        # 30+ test cases
tests/test_postprocess_cross_refs.py  # 25+ test cases
```

### Integration Tests
```python
# Test full pipeline with new structure
tests/test_golden_monsters.py      # Validate Aboleth, Goblin, Dragon
tests/test_golden_spells.py        # Validate spell cross-refs
tests/test_golden_equipment.py     # Validate equipment structure
```

### Schema Validation
```bash
# All generated JSON must validate against v2.0 schemas
pytest tests/test_json_sanity.py -v
```

### Edge Cases
- Speed with hover (e.g., "fly 60 ft. (hover)")
- Senses with conditions (e.g., "darkvision 60 ft. (blind beyond this radius)")
- AC with multiple sources (e.g., "16 (breastplate, shield)")
- Actions with multiple damage types (e.g., "1d6 piercing plus 2d6 poison")
- Complex cross-refs (e.g., "bludgeoning, piercing, and slashing from nonmagical attacks")

---

## Success Criteria

### Must Have (v0.19.0 Release Blockers)
- [ ] All schemas updated to v2.0.0
- [ ] All parsers generate v2.0 structure
- [ ] All golden tests pass with new structure
- [ ] Schema validation passes (test_json_sanity.py)
- [ ] Release notes document all breaking changes
- [ ] No regressions in data completeness (all 317 monsters, 319 spells, etc)

### Should Have (High Priority)
- [ ] Cross-reference type_id fields added
- [ ] Atomic reference datasets created (damage_types, skills, etc)
- [ ] Action structured fields populated (attack_bonus, damage_dice, etc)
- [ ] Documentation updated (ARCHITECTURE.md, README.md)

### Nice to Have (Optional Enhancements)
- [ ] Performance benchmarks (file size, parse time comparison)
- [ ] Structural comparison with dnd5eapi.co (validation script)
- [ ] Code coverage report (aim for 85%+)

---

## Risk Assessment

### High Risk
**Breaking changes affect all consumers**
- ✅ **ACCEPTED:** Clean break for improved data quality
- Mitigation: Clear release notes documenting all changes
- Mitigation: User will notify consumers of restructuring

**Parser complexity increase**
- Mitigation: Comprehensive unit tests for each parser
- Mitigation: Modular design (each field type isolated)
- Mitigation: Fail fast on parse errors (no silent fallbacks)

### Medium Risk
**Action parsing edge cases**
- Mitigation: Extensive test cases covering SRD variations
- Mitigation: Preserve description field as source of truth
- Mitigation: Structured fields are additive (not required)

**Schema validation failures**
- Mitigation: Incremental schema updates with validation
- Mitigation: Test against real data early and often
- Mitigation: Allow null/optional for complex fields

### Low Risk
**Cross-reference type_id mismatches**
- Mitigation: Fuzzy matching with manual review
- Mitigation: Log unmatched references for inspection
- Mitigation: Fall back to null if no match found

---

## Timeline

### Week 1: Schema & Examples (Dec 22-28)
- Update monster.schema.json to v2.0.0
- Create 3 migration examples (Aboleth, Goblin, Dragon)
- Validate examples pass schema checks

### Week 2: Parser Implementation (Dec 29 - Jan 4)
- Implement parse_speed.py, parse_senses.py, parse_armor_class.py
- Implement parse_actions.py with structured fields
- Unit test all new parsers (80%+ coverage)

### Week 3: Cross-Reference Postprocessing (Jan 5-11)
- Create atomic reference datasets
- Implement postprocess_cross_refs.py
- Integrate into assemble pipeline

### Week 4: Golden Test Updates (Jan 12-18)
- Regenerate all golden fixtures
- Update all test assertions for v2.0 structure
- Fix any edge cases or failures

### Week 5: Documentation & Release (Jan 19-25)
- Write migration guide
- Update ARCHITECTURE.md
- Create release notes
- **Release v0.19.0**

---

## Dependencies

### Internal
- ✅ v0.18.1 complete (all datasets stable)
- ✅ API structure analysis complete
- ✅ Schema examples validated

### External
- None (self-contained changes)

### Tooling
- Python 3.12+
- pytest (testing)
- jsonschema (validation)
- ruff (linting)

---

## Future Work (v0.20.0+)

### Deferred to v0.20.0
- Atomic reference datasets as separate files (damage_types.json, skills.json)
- Index optimization for cross-reference lookups
- FastAPI compatibility validation

### Deferred to v2.0.0
- Full REST API implementation
- Rich cross-reference objects `{index, name, url}`
- List/Detail endpoint split
- Field grouping (combat stats, defenses, etc)

---

## Questions & Decisions

### Resolved Decisions
- ✅ Use Option B (moderate) approach (not full dnd5eapi.co)
- ✅ Keep ability scores flat (proven pattern)
- ✅ Add structured fields without removing descriptions
- ✅ Schema version bump to v2.0.0 (breaking changes)
- ✅ **No backward compatibility** - clean break for quality
- ✅ **Consumer notification** - user will notify Blackmoor of breaking changes
- ✅ **Focus on clean code** - optimal structure over compatibility concerns

### Open Questions
1. **Performance impact:** Measure file size increase from nested objects?
   - Optional benchmark before release
   - Not a blocker - quality over size

---

## Approval & Sign-Off

**Plan Status:** Draft
**Reviewed By:** TBD
**Approved By:** TBD
**Target Release:** v0.19.0 (January 2026)

---

## Appendix: Example Transformations

### Aboleth (Complex Monster)
**Before (v0.18.1):**
```json
{
  "name": "Aboleth",
  "speed": "10 ft., swim 40 ft.",
  "senses": "darkvision 120 ft., passive Perception 20",
  "armor_class": "17 (natural armor)",
  "actions": [
    {
      "name": "Tentacle",
      "description": "Melee Weapon Attack: +9 to hit, reach 10 ft., one target. Hit: 12 (2d6 + 5) bludgeoning damage..."
    }
  ],
  "damage_resistances": [],
  "damage_immunities": []
}
```

**After (v0.19.0):**
```json
{
  "name": "Aboleth",
  "schema_version": "2.0.0",
  "data_version": "0.19.0",
  "index": "aboleth",
  "speed": {
    "walk": 10,
    "swim": 40,
    "fly": 0,
    "burrow": 0,
    "climb": 0,
    "hover": false
  },
  "senses": {
    "darkvision": 120,
    "blindsight": 0,
    "tremorsense": 0,
    "truesight": 0,
    "passive_perception": 20
  },
  "armor_class": {
    "base": 17,
    "source": "natural armor"
  },
  "actions": [
    {
      "name": "Tentacle",
      "description": "Melee Weapon Attack: +9 to hit, reach 10 ft., one target. Hit: 12 (2d6 + 5) bludgeoning damage...",
      "attack_bonus": 9,
      "damage_dice": "2d6+5",
      "damage_average": 12,
      "damage_types": ["bludgeoning"],
      "reach": 10
    }
  ],
  "damage_resistances": [],
  "damage_immunities": []
}
```

---

## Related Documents
- [API Structure Analysis](docs/external/api/API_STRUCTURE_ANALYSIS.md)
- [ARCHITECTURE.md](docs/ARCHITECTURE.md)
- [ROADMAP.md](docs/ROADMAP.md)
