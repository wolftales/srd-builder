# SRD-Builder Audit Report: Path to v1.0.0

**Date:** 2025-12-22
**Auditor:** Gemini-CLI

## 1. Introduction

This report contains the findings of a comprehensive audit of the `srd-builder` repository. The goal of this audit was to assess the project's overall health, identify data quality issues, and provide a clear set of actionable recommendations to prepare for a robust `v1.0.0` release. The audit covered project structure, build automation, dependency health, code quality, test coverage, documentation, and data integrity.

## 2. Executive Summary

`srd-builder` is a mature, well-engineered project with an exceptionally strong foundation. Its architecture, documentation, and build automation are significant strengths. However, the audit has identified **two critical data quality bugs** and several areas of technical debt that must be addressed to ensure a reliable `v1.0.0` release.

### Key Findings

*   **Critical:** A systemic parsing bug causes a majority of spells in the dataset to have missing or truncated descriptions.
*   **Critical:** Referential integrity is broken between equipment packs and the main equipment list.
*   **High:** The project has significant test coverage gaps, with several data parsing modules having 0% coverage. This likely masks other data quality issues.
*   **High:** The dependency chain includes 8 known security vulnerabilities that require remediation.
*   **Medium:** Type-checking is too lenient, giving a false sense of type safety.

### Top Recommendations for v1.0.0

1.  **Fix the Spell Parsing Pipeline:** Prioritize debugging the spell extraction and parsing logic to ensure all spell descriptions are captured correctly.
2.  **Remediate Security Vulnerabilities:** Update the 4 vulnerable dependencies to their recommended safe versions.
3.  **Increase Test Coverage:** Write comprehensive tests for all untested modules, especially `parse_madness`, `parse_poisons`, and `utils/table_indexer.py`.
4.  **Enforce Stricter Quality Gates:** Update the `mypy` configuration to disallow untyped function definitions and fix the resulting errors.

## 3. Project Strengths

The project excels in several areas that demonstrate a high level of engineering discipline:

*   **Project Structure:** The repository is clean, logically organized, and follows Python community best practices, making it easy to navigate.
*   **Build & Automation:** The `Makefile` and GitHub Actions CI pipeline are robust, modern, and well-configured. The use of `ruff`, `pre-commit`, and distinct build targets (`bundle`, `output`) is excellent.
*   **Documentation:** The external documentation (`README.md`, `ARCHITECTURE.md`) is exceptional. It is comprehensive, clear, and provides deep insight into the project's design, rationale, and operation. This is the project's biggest strength.
*   **Validation:** The project's commitment to data integrity is clear from the use of JSON Schemas, golden file tests, and dedicated validation scripts (`smoke`, `release-check`).

## 4. Detailed Findings & Recommendations

### 4.1. Data Quality

#### **Critical: Spell Descriptions are Missing or Truncated**

*   **Observation:** The `make release-check` command fails, reporting that a very large number of spells have "empty text." Manual inspection of the generated `spells.json` confirms that for many spells (e.g., "Cure Wounds", "Hold Person"), the `description` field is either missing its main body or contains only the "At Higher Levels" text.
*   **Impact:** This is a critical data integrity bug that makes the spells dataset largely unusable and untrustworthy.
*   **Recommendation:** This should be the highest-priority bug to fix before a `v1.0.0` release. The investigation should focus on the `extract_spells` and `parse_spell_records` functions to identify why the main description text is being dropped during the pipeline.

#### **High: Equipment Pack Referential Integrity is Broken**

*   **Observation:** The build process (`make bundle`) and validation scripts (`make smoke`) consistently log warnings for equipment packs, such as: `Priest's Pack: 4 items not in equipment.json`.
*   **Impact:** This indicates that the data is inconsistent. Content in one dataset references items that do not exist in another, which will cause errors for downstream consumers.
*   **Recommendation:** The logic for assembling equipment packs should be reviewed. The missing items should either be added to `equipment.json` or removed from the packs to ensure referential integrity.

### 4.2. Test Coverage

#### **High: Significant Gaps in Test Coverage**

*   **Observation:** The overall test coverage is a respectable **77%**. However, this top-level number masks critical gaps. Several modules responsible for data parsing and processing have dangerously low or zero coverage:
    *   `src/srd_builder/extraction/reference_data.py`: **0%**
    *   `src/srd_builder/parse/parse_madness.py`: **0%**
    *   `src/srd_builder/parse/parse_madness_tables.py`: **0%**
    *   `src/srd_builder/parse/parse_poisons.py`: **0%**
    *   `src/srd_builder/utils/table_indexer.py`: **19%**
    *   `src/srd_builder/extract/extract_pdf_metadata.py`: **21%**
*   **Impact:** The spell description bug demonstrates that the existing tests are not sufficient to catch systemic failures. The lack of tests for other parsing modules means other datasets (madness, poisons) are likely to have undiscovered data quality issues and cannot be considered "complete."
*   **Recommendation:** A major effort should be undertaken to write unit and golden tests for all untested modules. Priority should be given to the parsing modules and the critical `table_indexer` utility. Aim for a baseline of 85-90% coverage before the v1.0.0 release.

### 4.3. Dependency Health

#### **High: Known Security Vulnerabilities**

*   **Observation:** A `pip-audit` scan revealed **8 known vulnerabilities** across 4 packages: `filelock`, `pdfminer-six`, `pip`, and the direct dependency `pypdf`.
*   **Impact:** These vulnerabilities, while of varying severity, pose a security risk to the development environment and potentially to downstream users if the packages are bundled.
*   **Recommendation:**
    1.  Update the vulnerable packages to the recommended safe versions in `pyproject.toml`.
    2.  Consider adopting a dependency locking mechanism (e.g., `pip-tools`, `poetry`) to ensure reproducible builds and prevent new vulnerable packages from being installed automatically.

### 4.4. Code Quality and Maintainability

#### **Medium: Overly Permissive Type-Checking**

*   **Observation:** The `mypy` configuration includes `disallow_untyped_defs = false`, which causes the type-checker to ignore any function that lacks annotations. A stricter check (`mypy src --disallow-untyped-defs`) revealed **21 functions** without type hints.
*   **Impact:** This gives a false sense of security regarding type safety. The lack of type hints on core functions increases the risk of bugs and makes the code harder to maintain and refactor.
*   **Recommendation:**
    1.  Set `disallow_untyped_defs = true` in `pyproject.toml`.
    2.  Add the missing type annotations to resolve the `mypy` errors.
    3.  Remove `continue-on-error: true` from the `mypy` step in the `ci.yml` workflow to make type-checking a blocking requirement.

#### **Medium: Inconsistent Inline Documentation**

*   **Observation:** While external documentation is superb, inline documentation (docstrings) is inconsistent. The critical orchestration file, `src/srd_builder/build.py`, contains complex functions like `build` and `_write_datasets` that completely lack docstrings.
*   **Impact:** This makes it harder for new contributors to understand the core logic of the build pipeline.
*   **Recommendation:** Add comprehensive docstrings to all public modules and functions, as well as any complex internal functions, following PEP 257 conventions.

## 5. Conclusion

The `srd-builder` project is in a very strong position. The thoughtful architecture, excellent documentation, and robust automation are a credit to its developers.

To reach a `v1.0.0` milestone, the focus should be squarely on **data quality and reliability**. The spell description bug and the equipment pack inconsistency are the most significant blockers. Resolving these issues, remediating security vulnerabilities, and improving test coverage for the remaining blind spots will produce a dataset that is as trustworthy as the pipeline that builds it.
